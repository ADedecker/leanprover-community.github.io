---
layout: page
title: Lean Prover Zulip Chat Archive 
permalink: archive/113488general/44348Problemwithtypeclasssearch.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html">Problem with type class search</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">
{% raw %}
<a name="161435867"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161435867" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161435867">Johannes Hölzl (Mar 22 2019 at 10:22)</a>:</h4>
<p>Question: how much instances of <code>decidable (fin n)</code> are found by Lean? And why does it matter? Answer: <a href="https://github.com/johoelzl/tc-log-parser/blob/master/problem.md#answer" target="_blank" title="https://github.com/johoelzl/tc-log-parser/blob/master/problem.md#answer">https://github.com/johoelzl/tc-log-parser/blob/master/problem.md#answer</a></p>
<p><code>fin n</code> is just an example, even <code>decidable</code> is not the problem in itself. The problem will happen with each diamond where we have two ways to construct the same instance.</p>

<a name="161435923"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161435923" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161435923">Johannes Hölzl (Mar 22 2019 at 10:23)</a>:</h4>
<p>It looks like this is something we cannot solve in mathlib, but requires changes in Lean. <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span>: the type class search in Lean 4 will be the same as in Lean 3? So it would make sense to improve it in Lean 3 and then port it to Lean 4?</p>

<a name="161436171"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161436171" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161436171">Sebastian Ullrich (Mar 22 2019 at 10:28)</a>:</h4>
<p>Semantically it will probably stay the same, but Leo wants to look into possible optimizations. I will note this as one potential optimization opportunity, thanks for the write-up. No promises though.</p>

<a name="161436237"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161436237" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161436237">Johannes Hölzl (Mar 22 2019 at 10:29)</a>:</h4>
<p>Good to hear!</p>

<a name="161446859"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161446859" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161446859">Patrick Massot (Mar 22 2019 at 13:23)</a>:</h4>
<p><span class="user-mention" data-user-id="110294">@Johannes Hölzl</span> Could you tell us more about this repository?</p>

<a name="161446963"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161446963" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161446963">Patrick Massot (Mar 22 2019 at 13:24)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I think you should ask <span class="user-mention" data-user-id="110193">@Cyril Cohen</span> about ideas to improve the type class search semantic. In Amsterdam he told several things that got added to Coq recently and seemed like they could be very useful for large scale type class search</p>

<a name="161534653"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161534653" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161534653">Johannes Hölzl (Mar 23 2019 at 17:22)</a>:</h4>
<p>The idea is to have a parser for the log produced by Lean when searching for type class instances. All it currently does is to outpute the computed instances until a <code>mark ff</code> instance is looked up. This was the essential information I needed. </p>
<p>But I'm sure it can be used to analyse other problems too</p>

<a name="161692440"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161692440" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161692440">Johannes Hölzl (Mar 25 2019 at 22:05)</a>:</h4>
<p>Hm, this problem seams to be even worse: <code>is_add_monoid_hom (coe : ℤ → ℤ)</code> does not terminate. Now <code>is_ring_hom (coe : ℤ → ℤ)</code> doesn't work due to some unification problems. But <code> is_ring_hom.is_semiring_hom</code> <code>is_semiring_hom.is_add_monoid_hom</code> is looking for a <code>ring</code> instance and then for the <code>is_ring_hom</code> instance. The <code>is_ring_hom</code> instance is not found, hence it starts to enumerate all the ways to construct <code>ring</code> for <code>int</code>. </p>
<p>Maybe a solution would be to annotate <code>class</code> constants with a attribute, saying that there should be no backtracking, i.e. there should be only one canonical instance.</p>

<a name="161737408"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161737408" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161737408">Johan Commelin (Mar 26 2019 at 07:14)</a>:</h4>
<blockquote>
<p>Maybe a solution would be to annotate <code>class</code> constants with a attribute, saying that there should be no backtracking, i.e. there should be only one canonical instance.</p>
</blockquote>
<p>Isn't this how type class search is supposed to work anyway. So we can just bake that assumption in. If you found an instance, and it didn't work, just stop. No need to look for another instance.</p>

<a name="161740631"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161740631" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161740631">Johannes Hölzl (Mar 26 2019 at 08:23)</a>:</h4>
<p>Right, it should be the default behaviour.</p>

<a name="161740635"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161740635" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161740635">Johannes Hölzl (Mar 26 2019 at 08:23)</a>:</h4>
<p>Or even not configurable</p>

<a name="161848744"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161848744" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161848744">Rob Lewis (Mar 27 2019 at 11:06)</a>:</h4>
<p><span class="user-mention" data-user-id="213273">@Paul-Nicolas Madelaine</span>  and I came across a problem that I've seen before. Because of left-to-right elaboration, Lean won't coerce <code>n</code> to <code>ℤ</code> here:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">data</span><span class="bp">.</span><span class="n">int</span><span class="bp">.</span><span class="n">basic</span>
<span class="kn">example</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">z</span> <span class="o">:</span> <span class="bp">ℤ</span><span class="o">)</span> <span class="o">:</span> <span class="n">n</span> <span class="bp">&lt;</span> <span class="n">z</span> <span class="o">:=</span>
<span class="n">sorry</span>
</pre></div>


<p>Instead, it decides that <code>&lt;</code> is over <code>ℕ</code> and tries to coerce <code>z</code>. This should fail, but in practice it times out. I've noticed this many times but never had a chance to investigate. Turns out this is is another instance of the same type class issue Johannes reports. <code>int.cast_coe</code> looks, in order, for <code>has_zero ℕ</code>, <code>has_one ℕ</code>, <code>has_add ℕ</code>, and <code>has_neg ℕ</code>. There are tons of paths to the first three. (Presumably. I didn't count.) The last one fails. So the search goes effectively forever.</p>
<p>There's an easy solution for this particular case, though: change <code>int.cast_coe</code> to look for <code>has_neg</code> first. Then it fails fast. Nothing in mathlib breaks with this change. (I didn't compare compilation times.) This points to a general design strategy, as long as type class inference has this behavior: put the hardest (rarest, least likely) classes as early as possible.</p>

<a name="161851148"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161851148" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161851148">Johan Commelin (Mar 27 2019 at 11:47)</a>:</h4>
<p>Good idea. I'll try to keep it in mind while writing code.</p>

<a name="161894979"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161894979" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161894979">Kevin Buzzard (Mar 27 2019 at 19:56)</a>:</h4>
<p>So today will be remembered as the day that the age old question of why Lean times out when failing to coerce from int to nat is solved! <span class="user-mention" data-user-id="110294">@Johannes Hölzl</span> <span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> this trips up beginner mathematicians and is hard for them to debug. I think Johannes has found a fundamental issue which needs some serious thought.</p>

<a name="161895570"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895570" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895570">Kevin Buzzard (Mar 27 2019 at 20:03)</a>:</h4>
<p>So what Rob is saying, I think, is that in <code>data.int.basic</code> in mathlib, one of the lines here</p>
<div class="codehilite"><pre><span></span><span class="kn">section</span> <span class="n">cast</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span>

<span class="kn">section</span>
<span class="kn">variables</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_one</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_add</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_neg</span> <span class="n">α</span><span class="o">]</span>

<span class="c">/-</span><span class="cm">- Canonical homomorphism from the integers to any ring(-like) structure `α` -/</span>
<span class="kn">protected</span> <span class="n">def</span> <span class="n">cast</span> <span class="o">:</span> <span class="bp">ℤ</span> <span class="bp">→</span> <span class="n">α</span>
<span class="bp">|</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:=</span> <span class="n">n</span>
<span class="bp">|</span> <span class="bp">-</span><span class="o">[</span><span class="mi">1</span><span class="bp">+</span> <span class="n">n</span><span class="o">]</span> <span class="o">:=</span> <span class="bp">-</span><span class="o">(</span><span class="n">n</span><span class="bp">+</span><span class="mi">1</span><span class="o">)</span>

<span class="bp">@</span><span class="o">[</span><span class="n">priority</span> <span class="mi">0</span><span class="o">]</span> <span class="kn">instance</span> <span class="n">cast_coe</span> <span class="o">:</span> <span class="n">has_coe</span> <span class="bp">ℤ</span> <span class="n">α</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">int</span><span class="bp">.</span><span class="n">cast</span><span class="bp">⟩</span>
</pre></div>


<p>should be changed: the <em>order</em> of the variables should be changed.</p>

<a name="161895583"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895583" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895583">Johannes Hölzl (Mar 27 2019 at 20:03)</a>:</h4>
<p>Yes</p>

<a name="161895711"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895711" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895711">Johan Commelin (Mar 27 2019 at 20:05)</a>:</h4>
<p>That seems like an easy PR <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>

<a name="161895757"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895757" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895757">Johan Commelin (Mar 27 2019 at 20:05)</a>:</h4>
<p>Could even do that from the Github editor (-;</p>

<a name="161895819"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895819" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895819">Johannes Hölzl (Mar 27 2019 at 20:06)</a>:</h4>
<p>Another thing we need to change is actually Lean 3. We could fork Lean 3 and remove the ability to backtrack in Lean 3 and see what breaks in mathlib. This would make the type class search much easier.</p>

<a name="161895885"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895885" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895885">Johan Commelin (Mar 27 2019 at 20:07)</a>:</h4>
<p>Who is keeping track of all the benefits of forking?</p>

<a name="161895892"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895892" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895892">Johan Commelin (Mar 27 2019 at 20:07)</a>:</h4>
<p>There was a thread about this somewhere, right?</p>

<a name="161895908"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895908" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895908">Kevin Buzzard (Mar 27 2019 at 20:07)</a>:</h4>
<p>This is an edit to mathlib we're talking about here</p>

<a name="161895967"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161895967" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161895967">Kevin Buzzard (Mar 27 2019 at 20:08)</a>:</h4>
<p>Oh I see, Johannes is suggesting changing the C++ code?</p>

<a name="161896211"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161896211" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161896211">Rob Lewis (Mar 27 2019 at 20:11)</a>:</h4>
<p>The edit to mathlib should happen. And it seems worthwhile to experiment with a different type class search in a forked Lean. I would not want to port mathlib to this forked Lean 3, at least not without more knowledge of the Lean 4 type class mechanism.</p>

<a name="161899676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161899676" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161899676">Kevin Buzzard (Mar 27 2019 at 20:55)</a>:</h4>
<p>Results of a completely unscientific test; on this desktop, it took just under 15 minutes to compile mathlib HEAD, and then with the variable line in <code>data/int/basic.lean</code> changed to</p>
<div class="codehilite"><pre><span></span><span class="kn">variables</span> <span class="o">[</span><span class="n">has_neg</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_add</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_one</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">has_zero</span> <span class="n">α</span><span class="o">]</span>
</pre></div>


<p>(100% reversal) it took just under 14 minutes.</p>

<a name="161899966"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161899966" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161899966">Kevin Buzzard (Mar 27 2019 at 20:59)</a>:</h4>
<p>and <code>example : has_coe ℤ ℕ := by apply_instance</code> now fails instantly! I have never seen that before!</p>

<a name="161903595"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Problem%20with%20type%20class%20search/near/161903595" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/44348Problemwithtypeclasssearch.html#161903595">Chris Hughes (Mar 27 2019 at 21:50)</a>:</h4>
<p>We should make a Lean 4 todo list.</p>


{% endraw %}
