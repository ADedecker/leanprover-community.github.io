---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113488general/28140Findingdeterministictimeout.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html">Finding (deterministic) timeout</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="174471163"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174471163" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174471163">Floris van Doorn (Aug 29 2019 at 16:48)</a>:</h4>
<p>I made a change that created a (deterministic) timeout in PR <a href="https://github.com/leanprover-community/mathlib/issues/1319" target="_blank" title="https://github.com/leanprover-community/mathlib/issues/1319">#1319</a>. Lean is not very good reporting this error message:</p>
<ul>
<li>Travis failed with the error <code>/home/travis/scripts/travis_long: fork: Cannot allocate memory</code>. This was almost certainly because it ran across the timeout</li>
<li>When running <code>lean --make src/</code> the deterministic timeout failed silently. The first error message I received was in a file <em>importing</em> the file with the deterministic timeout (it did not create a <code>.olean</code> file for the file with the timeout).</li>
<li>Suppose <code>A.lean</code> has a deterministic timeout and you open <code>B.lean</code> in VSCode. <code>B.lean</code> does not raise any errors, not even <code>imported file uses sorry</code>.</li>
</ul>
<p>This made it tricky to find the file with the deterministic timeout. This post is mostly a cautionary tale. But if anyone knows a good way to find which file has the timeout, I'm happy to hear it. (on Windows <code>lean</code> doesn't report which file it is currently compiling, that might help)</p>

<a name="174471771"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174471771" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174471771">Simon Hudon (Aug 29 2019 at 16:57)</a>:</h4>
<p>Using a Makefile to build mathlib might help</p>

<a name="174471788"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174471788" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174471788">Simon Hudon (Aug 29 2019 at 16:57)</a>:</h4>
<p>I have a Makefile for it somewhere on my drive</p>

<a name="174488342"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488342" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488342">Floris van Doorn (Aug 29 2019 at 20:15)</a>:</h4>
<p>What is the difference of building mathlib with a Makefile and doing it without?</p>

<a name="174488429"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488429" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488429">Kevin Buzzard (Aug 29 2019 at 20:16)</a>:</h4>
<p>I thought you approved of automation? :-)</p>

<a name="174488473"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488473" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488473">Patrick Massot (Aug 29 2019 at 20:17)</a>:</h4>
<p>Are we talking about the benefit of have to type only <code>make</code> instead of <code>leanpkg build</code>?</p>

<a name="174488585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488585" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488585">Simon Hudon (Aug 29 2019 at 20:18)</a>:</h4>
<p>In this context, I'm suggesting that using <code>make</code> will let you see what file Lean is currently building. You should get a better idea of where the error is coming from</p>

<a name="174488607"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488607" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488607">Simon Hudon (Aug 29 2019 at 20:18)</a>:</h4>
<blockquote>
<p>I thought you approved of automation? :-)</p>
</blockquote>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span>  I'm not following</p>

<a name="174488632"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488632" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488632">Kevin Buzzard (Aug 29 2019 at 20:19)</a>:</h4>
<p>We can automate the use of <code>leanpkg</code> so we don't have to remember all those pesky extra inputs like <code>build</code></p>

<a name="174488651"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488651" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488651">Kevin Buzzard (Aug 29 2019 at 20:19)</a>:</h4>
<p>Oh! You think <code>make</code> will solve the issue of Windows not printing out file names?</p>

<a name="174488658"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488658" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488658">Kevin Buzzard (Aug 29 2019 at 20:19)</a>:</h4>
<p>I was just being daft.</p>

<a name="174488737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488737" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488737">Simon Hudon (Aug 29 2019 at 20:20)</a>:</h4>
<p>Haha! That's a more liberal use of the word "automation" than I'm used to</p>

<a name="174488754"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174488754" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174488754">Kevin Buzzard (Aug 29 2019 at 20:20)</a>:</h4>
<p>I'm a mathematician, what do I know about automation.</p>

<a name="174489811"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174489811" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174489811">Floris van Doorn (Aug 29 2019 at 20:32)</a>:</h4>
<blockquote>
<p>In this context, I'm suggesting that using <code>make</code> will let you see what file Lean is currently building. You should get a better idea of where the error is coming from</p>
</blockquote>
<p>I am very interested in this. How do I get/generate said Makefile?</p>

<a name="174490554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174490554" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174490554">Simon Hudon (Aug 29 2019 at 20:41)</a>:</h4>
<p>Here is the version I found: </p>
<div class="codehilite"><pre><span></span><span class="nv">SRCS</span> <span class="o">=</span> <span class="k">$(</span>wildcard */*.lean */*/*.lean */*/*/*.lean */*/*/*/*.lean<span class="k">)</span>
<span class="nv">OBJS</span> <span class="o">=</span> <span class="k">$(</span>SRCS:.lean<span class="o">=</span>.olean<span class="k">)</span>
<span class="nv">DEPS</span> <span class="o">=</span> <span class="k">$(</span>SRCS:.lean<span class="o">=</span>.depend<span class="k">)</span>

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">all</span> <span class="n">clean</span>

<span class="nf">all</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>

<span class="nf">depends</span><span class="o">:</span> <span class="k">$(</span><span class="nv">DEPS</span><span class="k">)</span>

<span class="nf">%.depend</span><span class="o">:</span> %.<span class="n">lean</span>
    @echo <span class="k">$(</span>&lt;:.lean<span class="o">=</span>.olean<span class="k">)</span>: <span class="sb">`</span>~/lean/lean-master/bin/lean --deps $&lt; <span class="p">|</span> python relative.py<span class="sb">`</span>  &gt; <span class="nv">$@</span>

<span class="c"># %.depend: ;</span>

<span class="nf">%.olean</span><span class="o">:</span> %.<span class="n">lean</span> %.<span class="n">depend</span>
    sccache lean --make $&lt;
<span class="c">#   sccache lean --make $&lt;</span>

<span class="nf">clean</span><span class="o">:</span>
    find . -name *.olean -delete
    find . -name *.depend -delete

<span class="nf">.PRECIOUS</span><span class="o">:</span> %.<span class="n">depend</span>

<span class="cp">include $(DEPS)</span>
</pre></div>


<p>It could be better but it works well enough for me</p>

<a name="174490584"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174490584" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174490584">Simon Hudon (Aug 29 2019 at 20:41)</a>:</h4>
<p>Basically, it has a pass to generate dependencies and then uses those to build in the proper order</p>

<a name="174491671"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Finding%20%28deterministic%29%20timeout/near/174491671" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/28140Findingdeterministictimeout.html#174491671">Floris van Doorn (Aug 29 2019 at 20:55)</a>:</h4>
<p>So I made a file <code>Makefile</code> with those contents in the <code>mathlib/</code> directory, but <code>make</code> isn't working. Any idea why?</p>
<div class="codehilite"><pre><span></span>Floris@MSI MINGW64 /d/projects/mathlib (use_localized)
$ make
Makefile:17: *** missing separator.  Stop.

Floris@MSI MINGW64 /d/projects/mathlib (use_localized)
$ make --version
GNU Make 4.2.1
Built for Windows32
Copyright (C) 1988-2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
</pre></div>


{% endraw %}

{% include archive_update.html %}