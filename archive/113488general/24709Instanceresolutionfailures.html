---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113488general/24709Instanceresolutionfailures.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113488general/index.html">general</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html">Instance resolution failures</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="175192998"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175192998" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175192998">Sebastian Ullrich (Sep 08 2019 at 17:46)</a>:</h4>
<p><span class="user-mention" data-user-id="110044">@Chris Hughes</span> </p>
<blockquote>
<p>I made a repository of examples of type class failures in Lean 3. Most of them depend on using some old commit of mathlib. The respository is <a href="https://github.com/ChrisHughes24/type_class" target="_blank" title="https://github.com/ChrisHughes24/type_class">here</a></p>
</blockquote>
<p>Thanks, this is a good first step. If we want to get serious about analyzing and fixing these issues in Lean 4 (I hope nobody expects a solution for Lean 3), it would help tremendously to reduce them to minimized examples in stand-alone files (we want to port mathlib to Lean 4 <em>after</em> fixing these issues after all). If they are already valid Lean 4, even better. We may even want to port them to other systems to analyze their behavior.</p>

<a name="175193324"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175193324" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175193324">Mario Carneiro (Sep 08 2019 at 17:57)</a>:</h4>
<p>It's not hard to cook up artificial examples, but I thought you wanted real examples</p>

<a name="175193380"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175193380" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175193380">Mario Carneiro (Sep 08 2019 at 17:58)</a>:</h4>
<p>In short it checks the same typeclass problem many times. This causes issues with looping instances, and exponential worst case behavior on dags</p>

<a name="175199193"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175199193" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175199193">Sebastian Ullrich (Sep 08 2019 at 20:55)</a>:</h4>
<p>We'd like to have realistic examples, but we'll still need to extract them if we want to test them in Lean 4</p>

<a name="175205903"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175205903" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175205903">Floris van Doorn (Sep 09 2019 at 00:23)</a>:</h4>
<p>Here is an unrealistic example which shows that diamonds cause an exponential blow-up in the type class inference search:</p>
<div class="codehilite"><pre><span></span><span class="c1">-- Lean 3 code</span>
<span class="kn">set_option</span> <span class="n">old_structure_cmd</span> <span class="n">true</span>
<span class="n">class</span> <span class="n">bottom</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">bool</span><span class="o">)</span>
<span class="n">class</span> <span class="n">left</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">bottom</span> <span class="n">α</span> <span class="n">n</span>
<span class="n">class</span> <span class="n">right</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">bottom</span> <span class="n">α</span> <span class="n">n</span>
<span class="n">class</span> <span class="n">top</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="kn">extends</span> <span class="n">left</span> <span class="n">α</span> <span class="n">n</span><span class="o">,</span> <span class="n">right</span> <span class="n">α</span> <span class="n">n</span>


<span class="kn">instance</span> <span class="n">unrealistic_loop</span> <span class="o">(</span><span class="n">α</span> <span class="n">n</span><span class="o">)</span> <span class="o">[</span><span class="n">bottom</span> <span class="n">α</span> <span class="n">n</span><span class="o">]</span> <span class="o">:</span> <span class="n">top</span> <span class="n">α</span> <span class="n">n</span><span class="bp">.</span><span class="n">succ</span> <span class="o">:=</span> <span class="o">{</span> <span class="bp">.._</span><span class="n">inst_1</span> <span class="o">}</span>

<span class="kn">set_option</span> <span class="n">trace</span><span class="bp">.</span><span class="n">class_instances</span> <span class="n">true</span>
<span class="kn">example</span> <span class="o">:</span> <span class="n">top</span> <span class="n">unit</span> <span class="mi">10</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">apply_instance</span> <span class="c1">-- fails, but slowly</span>
</pre></div>


<p>Even though this example is unrealistic, diamonds occur all over the algebraic hierarchy, and I don't think there is a way avoiding diamonds from the algebraic hierarchy. And this is not a large amount of diamonds, there is already a significant slowdown with 11 diamonds on top of each other. I think mathlib has more diamonds (more parallel instead of serial).</p>

<a name="175205975"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175205975" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175205975">Floris van Doorn (Sep 09 2019 at 00:24)</a>:</h4>
<p>In the stream <a href="#narrow/stream/113488-general/topic/more.20type.20class.20inference.20issues" title="#narrow/stream/113488-general/topic/more.20type.20class.20inference.20issues">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/more.20type.20class.20inference.20issues</a> I suggested:</p>
<blockquote>
<p>There should really be a different algorithm for these "forgetful instances". Make a graph of all instances that change the class but not the type (like <code>add_comm_group \a -&gt; add_group \a</code>) and when you have searched through all structural instances (or all instances with priority &gt;= default priority), then use a graph reachability algorithm to quickly search for a path to any instance in the local context.</p>
</blockquote>

<a name="175206555"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175206555" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175206555">Floris van Doorn (Sep 09 2019 at 00:41)</a>:</h4>
<p>I don't know if that is the best way to deal with diamonds, but it should avoid the exponential blowup.</p>

<a name="175222358"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175222358" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175222358">Sebastian Ullrich (Sep 09 2019 at 08:11)</a>:</h4>
<p>Thanks Floris. So are repeated (metavariable-free) instance problems the only big issue? Are <code>out_param</code>s more or less well behaved or were there fundamental issues as well?</p>

<a name="175225959"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175225959" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175225959">Keeley Hoek (Sep 09 2019 at 09:20)</a>:</h4>
<p><span class="user-mention" data-user-id="110087">@Scott Morrison</span> do you think the category theory morphism problems deserve a mention here?</p>

<a name="175226803"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175226803" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175226803">Scott Morrison (Sep 09 2019 at 09:36)</a>:</h4>
<p><span class="user-mention" data-user-id="110111">@Keeley Hoek</span> which did you have in mind?</p>

<a name="175226897"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175226897" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175226897">Keeley Hoek (Sep 09 2019 at 09:37)</a>:</h4>
<p>I meant the whole business with having to specify the morphism universe everywhere because the resolver can't be coerced into being more aggressive.</p>

<a name="175226982"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175226982" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175226982">Scott Morrison (Sep 09 2019 at 09:39)</a>:</h4>
<p>Oh, I see. Yes, it would be lovely if instance resolution would specialise universes in preference to failing.</p>

<a name="175227201"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175227201" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175227201">Keeley Hoek (Sep 09 2019 at 09:43)</a>:</h4>
<p>I'm not so familiar with <code>out_param</code>, but maybe an annotation like that saying to aggressively unify could be a fix.</p>

<a name="175307681"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175307681" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175307681">Floris van Doorn (Sep 10 2019 at 05:25)</a>:</h4>
<p><span class="user-mention" data-user-id="110024">@Sebastian Ullrich</span> I don't feel confident to judge whether this is the only issue. My gut feeling is that there are more issues, but it's not always easy to say which problem is causing a type class search to time out.<br>
I have not worked with <code>out_param</code>s myself, so I cannot judge judge them.</p>

<a name="175308232"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175308232" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175308232">Rob Lewis (Sep 10 2019 at 05:39)</a>:</h4>
<p>What's your timeline for collecting examples here? I'm limiting my Zulip time right now because I have too much else going on. But there are some bad instance searches I half-remember, and probably have saved on my office computer, I can try to write up once I get back there.</p>

<a name="175314585"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175314585" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175314585">Sebastian Ullrich (Sep 10 2019 at 08:02)</a>:</h4>
<p><span class="user-mention" data-user-id="110596">@Rob Lewis</span> There are always other things to work on for us, so I'd say take your time</p>

<a name="175315402"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175315402" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175315402">Mario Carneiro (Sep 10 2019 at 08:15)</a>:</h4>
<p><code>out_param</code> is finicky to use correctly, but AFAIK it doesn't cause any performance problems other than the preexisting ones</p>

<a name="175315475"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175315475" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175315475">Mario Carneiro (Sep 10 2019 at 08:16)</a>:</h4>
<p>I would say as long as you can make it not asymptotically exponential everything else will be minor</p>

<a name="175315579"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175315579" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175315579">Mario Carneiro (Sep 10 2019 at 08:18)</a>:</h4>
<p>TBH it's surprisingly fast considering how much work it is currently doing</p>

<a name="175316835"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/Instance%20resolution%20failures/near/175316835" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113488general/24709Instanceresolutionfailures.html#175316835">Scott Morrison (Sep 10 2019 at 08:39)</a>:</h4>
<p>I wonder if just looking through the 53 current instances of <code>set_option class.instance_max_depth ...</code> in mathlib would provide some interesting examples.</p>


{% endraw %}

{% include archive_update.html %}