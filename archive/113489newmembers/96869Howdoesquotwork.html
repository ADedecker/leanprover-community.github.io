---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/113489newmembers/96869Howdoesquotwork.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/113489newmembers/index.html">new members</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html">How does quot work?</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="183452359"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183452359" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183452359">Julian Gilbey (Dec 14 2019 at 18:29)</a>:</h4>
<p>I'm struggling to understand how <code>quot</code> actually works.  We have the definitions of <code>quot.mk</code> and <code>quot.ind</code> (in the core, they also appear as a comment in <code>init/core.lean</code>), namely</p>
<div class="codehilite"><pre><span></span><span class="kn">constant</span> <span class="n">quot</span><span class="bp">.</span><span class="n">mk</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="n">Sort</span> <span class="n">u</span><span class="o">}</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">quot</span> <span class="n">r</span>

<span class="kn">constant</span> <span class="n">quot</span><span class="bp">.</span><span class="n">lift</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="n">Sort</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="n">Sort</span> <span class="n">v</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">α</span><span class="o">,</span> <span class="n">r</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">eq</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="n">b</span><span class="o">))</span> <span class="bp">→</span> <span class="n">quot</span> <span class="n">r</span> <span class="bp">→</span> <span class="n">β</span>
</pre></div>


<p>But from there, in <code>init/data/quot.lean</code>, we have the lemma:</p>
<div class="codehilite"><pre><span></span><span class="kn">protected</span> <span class="kn">lemma</span> <span class="n">lift_beta</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="n">Sort</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="n">Sort</span> <span class="n">v</span><span class="o">}</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">c</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">r</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">f</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">lift</span> <span class="n">f</span> <span class="n">c</span> <span class="o">(</span><span class="n">quot</span><span class="bp">.</span><span class="n">mk</span> <span class="n">r</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="o">:=</span>
<span class="n">rfl</span>
</pre></div>


<p>So it seems as though Lean can deduce that <code>quot.lift</code> does exactly what we want it to.  Yet the definition only seems to specify the type of <code>quot.lift</code> as <code>quot r → β</code> but without specifying the behaviour on things of type <code>quot r</code>.  My guess is that the only possible meaning that could be given to the function is the one we expect, rather than something like a constant function.  But I'm clearly missing something here, yet I don't even know what I don't understand.  Help please?</p>

<a name="183452434"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183452434" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183452434">Kevin Buzzard (Dec 14 2019 at 18:30)</a>:</h4>
<p>Did you look at <a href="https://leanprover.github.io/theorem_proving_in_lean/axioms_and_computation.html#quotients" target="_blank" title="https://leanprover.github.io/theorem_proving_in_lean/axioms_and_computation.html#quotients">the relevant section of Theorem Proving in Lean</a>?</p>

<a name="183452451"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183452451" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183452451">Kevin Buzzard (Dec 14 2019 at 18:30)</a>:</h4>
<p>I implemented quotients myself as equivalence classes and this exercise taught me a lot about what was going on</p>

<a name="183452488"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183452488" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183452488">Kevin Buzzard (Dec 14 2019 at 18:32)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">axiom</span> <span class="n">quot</span><span class="bp">.</span><span class="n">sound</span> <span class="o">:</span>
  <span class="bp">∀</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">{</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">α</span><span class="o">},</span>
    <span class="n">r</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">quot</span><span class="bp">.</span><span class="n">mk</span> <span class="n">r</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">quot</span><span class="bp">.</span><span class="n">mk</span> <span class="n">r</span> <span class="n">b</span>
</pre></div>


<p>is the axiom which tells you that <code>quot.mk</code> is what you think it should be</p>

<a name="183452528"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183452528" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183452528">Reid Barton (Dec 14 2019 at 18:32)</a>:</h4>
<p>The thing that makes <code>lift_beta</code> work is called the computation rule for <code>quot</code> and it's also magically added by <code>init_quotient</code></p>

<a name="183452554"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183452554" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183452554">Kevin Buzzard (Dec 14 2019 at 18:33)</a>:</h4>
<p>For me, part of the problem was that the names of the functions in Lean are very unlike the ones which I would use. For example <code>quot.lift</code> doesn't lift a map from the quotient to a map on the original type, it descends a map on the type which plays well with the equivalence relation to a map on the quotient.</p>

<a name="183452558"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183452558" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183452558">Kevin Buzzard (Dec 14 2019 at 18:33)</a>:</h4>
<p>Another thing that helped was working out one explicit example, which I did here: <a href="https://github.com/leanprover-community/mathlib/blob/master/docs/tutorial/Zmod37.lean" target="_blank" title="https://github.com/leanprover-community/mathlib/blob/master/docs/tutorial/Zmod37.lean">https://github.com/leanprover-community/mathlib/blob/master/docs/tutorial/Zmod37.lean</a></p>

<a name="183453283"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183453283" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183453283">Kevin Buzzard (Dec 14 2019 at 18:52)</a>:</h4>
<p>Old gist of <span class="user-mention" data-user-id="110049">@Mario Carneiro</span> :</p>
<div class="codehilite"><pre><span></span><span class="c">/-</span><span class="cm"></span>
<span class="cm">  Presheaf (of types).</span>
<span class="cm">  https://stacks.math.columbia.edu/tag/006D</span>
<span class="cm">-/</span>

<span class="kn">import</span> <span class="n">topology</span><span class="bp">.</span><span class="n">basic</span>
<span class="kn">import</span> <span class="n">topology</span><span class="bp">.</span><span class="n">opens</span>
<span class="kn">import</span> <span class="n">order</span><span class="bp">.</span><span class="n">bounds</span>

<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span>

<span class="c1">-- Definition of a presheaf.</span>

<span class="kn">open</span> <span class="n">topological_space</span> <span class="n">lattice</span>

<span class="kn">structure</span> <span class="n">presheaf</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">F</span>     <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span>
<span class="o">(</span><span class="n">res</span>   <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">U</span> <span class="n">V</span><span class="o">)</span> <span class="o">(</span><span class="n">HVU</span> <span class="o">:</span> <span class="n">V</span> <span class="bp">≤</span> <span class="n">U</span><span class="o">),</span> <span class="n">F</span> <span class="n">U</span> <span class="bp">→</span> <span class="n">F</span> <span class="n">V</span><span class="o">)</span>
<span class="o">(</span><span class="n">Hid</span>   <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">U</span><span class="o">),</span> <span class="n">res</span> <span class="n">U</span> <span class="n">U</span> <span class="o">(</span><span class="n">le_refl</span> <span class="n">U</span><span class="o">)</span> <span class="bp">=</span> <span class="n">id</span><span class="o">)</span>
<span class="o">(</span><span class="n">Hcomp</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">U</span> <span class="n">V</span> <span class="n">W</span><span class="o">)</span> <span class="o">(</span><span class="n">HWV</span> <span class="o">:</span> <span class="n">W</span> <span class="bp">≤</span> <span class="n">V</span><span class="o">)</span> <span class="o">(</span><span class="n">HVU</span> <span class="o">:</span> <span class="n">V</span> <span class="bp">≤</span> <span class="n">U</span><span class="o">),</span>
  <span class="n">res</span> <span class="n">U</span> <span class="n">W</span> <span class="o">(</span><span class="n">le_trans</span> <span class="n">HWV</span> <span class="n">HVU</span><span class="o">)</span> <span class="bp">=</span> <span class="n">res</span> <span class="n">V</span> <span class="n">W</span> <span class="n">HWV</span> <span class="err">∘</span> <span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">)</span>

<span class="kn">namespace</span> <span class="n">presheaf</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">F</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">,</span>
  <span class="n">coe</span> <span class="o">:=</span> <span class="n">presheaf</span><span class="bp">.</span><span class="n">F</span> <span class="o">}</span>

<span class="c1">-- Simplification lemmas for Hid and Hcomp.</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">Hcomp&#39;</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span>
<span class="bp">∀</span> <span class="o">(</span><span class="n">U</span> <span class="n">V</span> <span class="n">W</span><span class="o">)</span> <span class="o">(</span><span class="n">HWV</span> <span class="o">:</span> <span class="n">W</span> <span class="bp">≤</span> <span class="n">V</span><span class="o">)</span> <span class="o">(</span><span class="n">HVU</span> <span class="o">:</span> <span class="n">V</span> <span class="bp">≤</span> <span class="n">U</span><span class="o">)</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">),</span>
  <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">W</span> <span class="o">(</span><span class="n">le_trans</span> <span class="n">HWV</span> <span class="n">HVU</span><span class="o">))</span> <span class="n">s</span> <span class="bp">=</span>
  <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">V</span> <span class="n">W</span> <span class="n">HWV</span><span class="o">)</span> <span class="o">((</span><span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">)</span> <span class="n">s</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">W</span> <span class="n">HWV</span> <span class="n">HVU</span> <span class="n">s</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">F</span><span class="bp">.</span><span class="n">Hcomp</span> <span class="n">U</span> <span class="n">V</span> <span class="n">W</span> <span class="n">HWV</span> <span class="n">HVU</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">Hid&#39;</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span>
<span class="bp">∀</span> <span class="o">(</span><span class="n">U</span><span class="o">)</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">),</span>
  <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">U</span> <span class="o">(</span><span class="n">le_refl</span> <span class="n">U</span><span class="o">))</span> <span class="n">s</span> <span class="bp">=</span> <span class="n">s</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">U</span> <span class="n">s</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">F</span><span class="bp">.</span><span class="n">Hid</span> <span class="n">U</span><span class="bp">;</span> <span class="n">simp</span>

<span class="n">def</span> <span class="n">total</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="kt">Type</span> <span class="o">(</span><span class="n">max</span> <span class="n">u</span> <span class="n">v</span><span class="o">)</span> <span class="o">:=</span> <span class="err">Σ</span> <span class="n">U</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">F</span> <span class="n">U</span>

<span class="kn">instance</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">U</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">has_coe_t</span> <span class="o">(</span><span class="n">F</span> <span class="n">U</span><span class="o">)</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span> <span class="o">:=</span>
<span class="bp">⟨</span><span class="n">sigma</span><span class="bp">.</span><span class="n">mk</span> <span class="bp">_⟩</span>

<span class="bp">@</span><span class="o">[</span><span class="n">elab_as_eliminator</span><span class="o">]</span>
<span class="kn">theorem</span> <span class="n">total</span><span class="bp">.</span><span class="n">cases_on</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">C</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span> <span class="bp">→</span> <span class="n">Sort</span><span class="bp">*</span><span class="o">}</span>
  <span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">U</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">),</span> <span class="n">C</span> <span class="n">x</span><span class="o">)</span> <span class="o">:</span> <span class="n">C</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">cases</span> <span class="n">x</span><span class="bp">;</span> <span class="n">apply</span> <span class="n">H</span>

<span class="n">def</span> <span class="n">res&#39;</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">V</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span> <span class="bp">→</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span>
<span class="bp">|</span> <span class="bp">⟨</span><span class="n">U</span><span class="o">,</span> <span class="n">x</span><span class="bp">⟩</span> <span class="o">:=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="o">(</span><span class="n">U</span> <span class="err">⊓</span> <span class="n">V</span><span class="o">)</span> <span class="n">inf_le_left</span> <span class="n">x</span>

<span class="kn">theorem</span> <span class="n">res&#39;_def</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="o">(</span><span class="n">U</span> <span class="err">⊓</span> <span class="n">V</span><span class="o">)</span> <span class="n">inf_le_left</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">theorem</span> <span class="n">res&#39;_val</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">V</span> <span class="bp">≤</span> <span class="n">U</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">have</span> <span class="bp">∀</span> <span class="n">W</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">W</span> <span class="bp">≤</span> <span class="n">U</span><span class="o">),</span> <span class="n">W</span> <span class="bp">=</span> <span class="n">V</span> <span class="bp">→</span>
  <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">W</span> <span class="n">H</span> <span class="n">x</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span><span class="o">)</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span> <span class="n">x</span> <span class="o">:=</span>
  <span class="k">by</span> <span class="n">rintro</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">rfl</span><span class="bp">;</span> <span class="n">refl</span><span class="o">,</span>
<span class="n">this</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">inf_of_le_right</span> <span class="n">h</span><span class="o">)</span>

<span class="kn">theorem</span> <span class="n">res&#39;_eq_inf</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="o">(</span><span class="n">U</span> <span class="err">⊓</span> <span class="n">V</span><span class="o">)</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">res&#39;_def</span><span class="o">,</span> <span class="err">←</span> <span class="n">res&#39;_val</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">inf_le_left</span><span class="o">]</span>

<span class="kn">theorem</span> <span class="n">res&#39;_eq_left</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span> <span class="n">W</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">)</span> <span class="o">(</span><span class="n">H</span> <span class="o">:</span> <span class="n">U</span> <span class="err">⊓</span> <span class="n">V</span> <span class="bp">=</span> <span class="n">U</span> <span class="err">⊓</span> <span class="n">W</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">W</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">res&#39;_eq_inf</span><span class="o">,</span> <span class="n">H</span><span class="o">,</span> <span class="err">←</span> <span class="n">res&#39;_eq_inf</span><span class="o">]</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">res&#39;_id</span> <span class="o">{</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">}</span> <span class="o">{</span><span class="n">U</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">)</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">U</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">x</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">res&#39;_val</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">le_refl</span> <span class="n">U</span><span class="o">),</span> <span class="n">F</span><span class="bp">.</span><span class="n">Hid</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">res&#39;_comp</span> <span class="o">{</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">}</span> <span class="o">{</span><span class="n">U</span> <span class="n">V</span><span class="o">}</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">U</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="o">(</span><span class="n">U</span> <span class="err">⊓</span> <span class="n">V</span><span class="o">)</span> <span class="n">x</span> <span class="o">:=</span>
<span class="n">total</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">F</span> <span class="n">x</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">W</span> <span class="n">x</span><span class="o">,</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">res&#39;_def</span><span class="o">,</span> <span class="n">res&#39;_def</span><span class="o">,</span> <span class="err">←</span> <span class="n">F</span><span class="bp">.</span><span class="n">Hcomp&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">res&#39;_val</span><span class="o">,</span> <span class="n">res&#39;_eq_left</span><span class="o">]</span><span class="bp">;</span>
   <span class="n">simp</span> <span class="o">[</span><span class="n">inf_left_comm</span><span class="o">,</span> <span class="n">inf_comm</span><span class="o">]</span>

<span class="c1">-- Morphism of presheaves.</span>

<span class="c1">-- Kenny wants morphisms on the subsheaves</span>
<span class="kn">structure</span> <span class="n">morphism</span> <span class="o">(</span><span class="n">F</span> <span class="n">G</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">map</span>      <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">U</span><span class="o">),</span> <span class="n">F</span> <span class="n">U</span> <span class="bp">→</span> <span class="n">G</span> <span class="n">U</span><span class="o">)</span>
<span class="o">(</span><span class="n">commutes</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">U</span> <span class="n">V</span><span class="o">)</span> <span class="o">(</span><span class="n">HVU</span> <span class="o">:</span> <span class="n">V</span> <span class="bp">≤</span> <span class="n">U</span><span class="o">),</span>
  <span class="o">(</span><span class="n">G</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">)</span> <span class="err">∘</span> <span class="o">(</span><span class="n">map</span> <span class="n">U</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">map</span> <span class="n">V</span><span class="o">)</span> <span class="err">∘</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">))</span>

<span class="kn">infix</span> <span class="bp">`</span> <span class="err">⟶</span> <span class="bp">`</span><span class="o">:</span><span class="mi">80</span> <span class="o">:=</span> <span class="n">morphism</span>

<span class="kn">section</span> <span class="n">morphism</span>

<span class="n">def</span> <span class="n">comp</span> <span class="o">{</span><span class="n">F</span> <span class="n">G</span> <span class="n">H</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">fg</span> <span class="o">:</span> <span class="n">F</span> <span class="err">⟶</span> <span class="n">G</span><span class="o">)</span> <span class="o">(</span><span class="n">gh</span> <span class="o">:</span> <span class="n">G</span> <span class="err">⟶</span> <span class="n">H</span><span class="o">)</span> <span class="o">:</span> <span class="n">F</span> <span class="err">⟶</span> <span class="n">H</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="n">gh</span><span class="bp">.</span><span class="n">map</span> <span class="n">U</span> <span class="err">∘</span> <span class="n">fg</span><span class="bp">.</span><span class="n">map</span> <span class="n">U</span><span class="o">,</span>
  <span class="n">commutes</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">,</span>
    <span class="k">begin</span>
      <span class="n">rw</span> <span class="o">[</span><span class="err">←</span><span class="n">function</span><span class="bp">.</span><span class="n">comp</span><span class="bp">.</span><span class="n">assoc</span><span class="o">,</span> <span class="n">gh</span><span class="bp">.</span><span class="n">commutes</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">],</span> <span class="n">symmetry</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">function</span><span class="bp">.</span><span class="n">comp</span><span class="bp">.</span><span class="n">assoc</span><span class="o">,</span> <span class="err">←</span><span class="n">fg</span><span class="bp">.</span><span class="n">commutes</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">]</span>
    <span class="kn">end</span> <span class="o">}</span>

<span class="kn">infix</span> <span class="bp">`</span> <span class="err">⊚</span> <span class="bp">`</span><span class="o">:</span><span class="mi">80</span> <span class="o">:=</span> <span class="n">comp</span>

<span class="n">def</span> <span class="n">id</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">F</span> <span class="err">⟶</span> <span class="n">F</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">map</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span>
  <span class="n">commutes</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">U</span> <span class="n">V</span> <span class="n">HVU</span><span class="o">,</span> <span class="k">by</span> <span class="n">simp</span><span class="o">,</span> <span class="o">}</span>

<span class="kn">structure</span> <span class="n">iso</span> <span class="o">(</span><span class="n">F</span> <span class="n">G</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">mor</span> <span class="o">:</span> <span class="n">F</span> <span class="err">⟶</span> <span class="n">G</span><span class="o">)</span>
<span class="o">(</span><span class="n">inv</span> <span class="o">:</span> <span class="n">G</span> <span class="err">⟶</span> <span class="n">F</span><span class="o">)</span>
<span class="o">(</span><span class="n">mor_inv_id</span> <span class="o">:</span> <span class="n">mor</span> <span class="err">⊚</span> <span class="n">inv</span> <span class="bp">=</span> <span class="n">id</span> <span class="n">F</span><span class="o">)</span>
<span class="o">(</span><span class="n">inv_mor_id</span> <span class="o">:</span> <span class="n">inv</span> <span class="err">⊚</span> <span class="n">mor</span> <span class="bp">=</span> <span class="n">id</span> <span class="n">G</span><span class="o">)</span>

<span class="kn">infix</span> <span class="bp">`</span> <span class="err">≅</span> <span class="bp">`</span><span class="o">:</span><span class="mi">80</span> <span class="o">:=</span> <span class="n">iso</span>

<span class="kn">end</span> <span class="n">morphism</span>

<span class="kn">section</span> <span class="n">sheaf_condition</span>

<span class="c1">-- Sheaf condition.</span>

<span class="n">def</span> <span class="n">locality</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">∀</span> <span class="o">{{</span><span class="n">U</span> <span class="n">S</span><span class="o">}},</span> <span class="n">is_lub</span> <span class="n">S</span> <span class="n">U</span> <span class="bp">→</span> <span class="bp">∀</span> <span class="o">{{</span><span class="n">s</span> <span class="n">t</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">}},</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="n">V</span> <span class="err">∈</span> <span class="n">S</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">s</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">t</span><span class="o">)</span> <span class="bp">→</span> <span class="n">s</span> <span class="bp">=</span> <span class="n">t</span>

<span class="n">def</span> <span class="n">gluing</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">∀</span> <span class="o">{{</span><span class="n">U</span> <span class="o">:</span> <span class="n">α</span><span class="o">}}</span> <span class="o">{{</span><span class="n">S</span><span class="o">}},</span> <span class="n">is_lub</span> <span class="n">S</span> <span class="n">U</span> <span class="bp">→</span> <span class="bp">∀</span> <span class="o">(</span><span class="n">s</span> <span class="o">:</span> <span class="bp">Π</span> <span class="n">V</span> <span class="o">:</span> <span class="n">S</span><span class="o">,</span> <span class="n">F</span> <span class="n">V</span><span class="o">),</span>
  <span class="o">(</span><span class="bp">∀</span> <span class="n">V</span> <span class="n">W</span> <span class="o">:</span> <span class="n">S</span><span class="o">,</span> <span class="n">res&#39;</span> <span class="n">F</span> <span class="o">(</span><span class="n">V</span> <span class="err">⊓</span> <span class="n">W</span><span class="o">)</span> <span class="o">(</span><span class="n">s</span> <span class="n">V</span><span class="o">)</span> <span class="bp">=</span> <span class="n">res&#39;</span> <span class="n">F</span> <span class="o">(</span><span class="n">V</span> <span class="err">⊓</span> <span class="n">W</span><span class="o">)</span> <span class="o">(</span><span class="n">s</span> <span class="n">W</span><span class="o">))</span> <span class="bp">→</span>
  <span class="bp">∃</span> <span class="n">x</span> <span class="o">:</span> <span class="n">F</span> <span class="n">U</span><span class="o">,</span> <span class="bp">∀</span> <span class="n">V</span><span class="o">:</span><span class="n">S</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="n">x</span> <span class="bp">=</span> <span class="n">s</span> <span class="n">V</span>

<span class="n">def</span> <span class="n">is_sheaf</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="n">locality</span> <span class="n">F</span> <span class="bp">∧</span> <span class="n">gluing</span> <span class="n">F</span>

<span class="kn">end</span> <span class="n">sheaf_condition</span>

<span class="kn">end</span> <span class="n">presheaf</span>

<span class="kn">structure</span> <span class="n">semilattice_inf_hom</span>
  <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span><span class="o">)</span>
<span class="o">(</span><span class="n">mono</span> <span class="o">:</span> <span class="n">monotone</span> <span class="n">to_fun</span><span class="o">)</span>
<span class="o">(</span><span class="n">map_inf&#39;</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">a</span> <span class="err">⊓</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">to_fun</span> <span class="n">a</span> <span class="err">⊓</span> <span class="n">to_fun</span> <span class="n">b</span><span class="o">)</span>

<span class="kn">namespace</span> <span class="n">semilattice_inf_hom</span>

<span class="kn">infixr</span> <span class="bp">`</span> <span class="bp">→</span><span class="err">⊓</span> <span class="bp">`</span><span class="o">:</span><span class="mi">25</span> <span class="o">:=</span> <span class="n">semilattice_inf_hom</span>

<span class="kn">instance</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">to_fun</span><span class="bp">⟩</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">map_inf</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="err">⊓</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="err">⊓</span> <span class="n">f</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">map_inf&#39;</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span>

<span class="n">def</span> <span class="n">id</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">α</span> <span class="o">:=</span>
<span class="bp">⟨</span><span class="n">id</span><span class="o">,</span> <span class="n">monotone_id</span><span class="o">,</span> <span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span>

<span class="n">def</span> <span class="n">comp</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">γ</span><span class="o">]</span>
  <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">γ</span> <span class="o">:=</span>
<span class="bp">⟨</span><span class="n">g</span> <span class="err">∘</span> <span class="n">f</span><span class="o">,</span> <span class="n">monotone</span><span class="bp">.</span><span class="n">comp</span> <span class="n">g</span><span class="bp">.</span><span class="n">mono</span> <span class="n">f</span><span class="bp">.</span><span class="n">mono</span><span class="o">,</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">simp</span><span class="bp">⟩</span>

<span class="kn">end</span> <span class="n">semilattice_inf_hom</span>

<span class="kn">structure</span> <span class="n">semilattice_inf_lub_emb</span>
  <span class="o">(</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">)</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span> <span class="kn">extends</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">inj</span> <span class="o">:</span> <span class="n">function</span><span class="bp">.</span><span class="n">injective</span> <span class="n">to_fun</span><span class="o">)</span>
<span class="o">(</span><span class="n">map_lub</span> <span class="o">:</span> <span class="bp">∀</span> <span class="o">{{</span><span class="n">S</span> <span class="n">a</span><span class="o">}},</span> <span class="n">is_lub</span> <span class="n">S</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">is_lub</span> <span class="o">(</span><span class="n">to_fun</span> <span class="err">&#39;&#39;</span> <span class="n">S</span><span class="o">)</span> <span class="o">(</span><span class="n">to_fun</span> <span class="n">a</span><span class="o">))</span>

<span class="kn">namespace</span> <span class="n">semilattice_inf_lub_emb</span>

<span class="kn">infixr</span> <span class="bp">`</span> <span class="err">↪⊓⨆</span> <span class="bp">`</span><span class="o">:</span><span class="mi">25</span> <span class="o">:=</span> <span class="n">semilattice_inf_lub_emb</span>

<span class="kn">instance</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span> <span class="o">:</span>
  <span class="n">has_coe</span> <span class="o">(</span><span class="n">α</span> <span class="err">↪⊓⨆</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">⟨</span><span class="n">to_semilattice_inf_hom</span><span class="bp">⟩</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">map_inf</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="err">↪⊓⨆</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">f</span> <span class="o">(</span><span class="n">a</span> <span class="err">⊓</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span> <span class="err">⊓</span> <span class="n">f</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_inf&#39;</span> <span class="bp">_</span> <span class="bp">_</span>

<span class="n">def</span> <span class="n">id</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">:</span> <span class="n">α</span> <span class="err">↪⊓⨆</span> <span class="n">α</span> <span class="o">:=</span>
<span class="bp">⟨</span><span class="n">semilattice_inf_hom</span><span class="bp">.</span><span class="n">id</span><span class="o">,</span> <span class="n">function</span><span class="bp">.</span><span class="n">injective_id</span><span class="o">,</span>
  <span class="bp">λ</span> <span class="n">S</span> <span class="n">a</span> <span class="n">h</span><span class="o">,</span> <span class="k">by</span> <span class="n">simp</span> <span class="o">[</span><span class="n">semilattice_inf_hom</span><span class="bp">.</span><span class="n">id</span><span class="o">,</span> <span class="n">h</span><span class="o">]</span><span class="bp">⟩</span>

<span class="n">def</span> <span class="n">comp</span> <span class="o">{</span><span class="n">α</span> <span class="n">β</span> <span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">γ</span><span class="o">]</span>
  <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">β</span> <span class="err">↪⊓⨆</span> <span class="n">γ</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="err">↪⊓⨆</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="err">↪⊓⨆</span> <span class="n">γ</span> <span class="o">:=</span>
<span class="bp">⟨</span><span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="n">β</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">γ</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="n">f</span><span class="o">,</span> <span class="n">function</span><span class="bp">.</span><span class="n">injective_comp</span> <span class="n">g</span><span class="bp">.</span><span class="n">inj</span> <span class="n">f</span><span class="bp">.</span><span class="n">inj</span><span class="o">,</span>
  <span class="bp">λ</span> <span class="n">S</span> <span class="n">a</span> <span class="n">h</span><span class="o">,</span> <span class="k">by</span> <span class="k">have</span> <span class="o">:=</span> <span class="n">g</span><span class="bp">.</span><span class="n">map_lub</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">map_lub</span> <span class="n">h</span><span class="o">)</span><span class="bp">;</span> <span class="n">rwa</span> <span class="o">[</span><span class="n">set</span><span class="bp">.</span><span class="n">image_image</span><span class="o">]</span> <span class="n">at</span> <span class="n">this</span><span class="bp">⟩</span>

<span class="kn">end</span> <span class="n">semilattice_inf_lub_emb</span>

<span class="kn">namespace</span> <span class="n">presheaf</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span>

<span class="n">def</span> <span class="n">comap</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">F</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">F</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">),</span>
  <span class="n">res</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span> <span class="n">h</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">mono</span> <span class="n">h</span><span class="o">),</span>
  <span class="n">Hid</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">Hid</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">Hcomp</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">bc</span> <span class="n">ab</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">Hcomp</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">theorem</span> <span class="n">comap_res</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">h</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">res</span> <span class="n">a</span> <span class="n">b</span> <span class="n">h</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">mono</span> <span class="n">h</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">instance</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">has_coe</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">total</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span> <span class="o">:=</span>
<span class="bp">⟨λ</span> <span class="n">x</span><span class="o">,</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">x</span><span class="bp">.</span><span class="mi">2</span><span class="bp">⟩⟩</span>

<span class="kn">theorem</span> <span class="n">comap_coe_inj</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">function</span><span class="bp">.</span><span class="n">injective</span> <span class="n">f</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">function</span><span class="bp">.</span><span class="n">injective</span> <span class="o">(</span><span class="n">coe</span> <span class="o">:</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">total</span> <span class="bp">→</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span><span class="o">)</span>
<span class="bp">|</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">x</span><span class="bp">⟩</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span> <span class="n">y</span><span class="bp">⟩</span> <span class="n">e</span> <span class="o">:=</span> <span class="k">by</span> <span class="n">cases</span> <span class="n">h</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="n">sigma</span><span class="bp">.</span><span class="n">fst</span> <span class="n">e</span><span class="o">:</span><span class="bp">_</span><span class="o">)</span><span class="bp">;</span> <span class="n">cases</span> <span class="n">e</span><span class="bp">;</span> <span class="n">refl</span>

<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">coe_total_coe</span>
  <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">U</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span> <span class="n">U</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">((</span><span class="n">x</span> <span class="o">:</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">total</span><span class="o">)</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">coe</span> <span class="o">(</span><span class="n">F</span> <span class="o">(</span><span class="n">f</span> <span class="n">U</span><span class="o">))</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">x</span> <span class="o">:=</span> <span class="n">rfl</span>

<span class="kn">theorem</span> <span class="n">comap_res&#39;</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">presheaf</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">U</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">total</span><span class="o">)</span> <span class="o">:</span>
  <span class="err">↑</span><span class="o">((</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">U</span> <span class="n">x</span><span class="o">)</span> <span class="bp">=</span> <span class="n">F</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="o">(</span><span class="n">f</span> <span class="n">U</span><span class="o">)</span> <span class="n">x</span> <span class="o">:=</span>
<span class="n">total</span><span class="bp">.</span><span class="n">cases_on</span> <span class="o">(</span><span class="n">F</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="o">)</span> <span class="n">x</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">W</span> <span class="n">x</span><span class="o">,</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">res&#39;_def</span><span class="o">,</span> <span class="n">coe_total_coe</span><span class="o">,</span> <span class="n">coe_total_coe</span><span class="o">,</span> <span class="n">comap_res</span><span class="o">,</span> <span class="err">←</span> <span class="n">res&#39;_val</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_inf</span><span class="o">,</span>
       <span class="err">←</span> <span class="n">res&#39;_eq_inf</span><span class="o">]</span>

<span class="kn">end</span> <span class="n">presheaf</span>

<span class="kn">structure</span> <span class="n">sheaf</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="kn">extends</span> <span class="n">presheaf</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">locality</span> <span class="o">:</span> <span class="n">to_presheaf</span><span class="bp">.</span><span class="n">locality</span><span class="o">)</span>
<span class="o">(</span><span class="n">gluing</span>   <span class="o">:</span> <span class="n">to_presheaf</span><span class="bp">.</span><span class="n">gluing</span><span class="o">)</span>

<span class="kn">structure</span> <span class="n">sheaf_of_rings</span> <span class="o">(</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="kn">extends</span> <span class="n">sheaf</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">[</span><span class="n">ring&#39;</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">U</span><span class="o">,</span> <span class="n">ring</span> <span class="o">(</span><span class="n">F</span> <span class="n">U</span><span class="o">)]</span>
<span class="o">[</span><span class="n">ring_hom</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span><span class="o">,</span> <span class="n">is_ring_hom</span> <span class="o">(</span><span class="n">res</span> <span class="n">U</span> <span class="n">V</span> <span class="n">h</span><span class="o">)]</span>

<span class="kn">namespace</span> <span class="n">sheaf</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span><span class="bp">*</span><span class="o">}</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">semilattice_inf</span> <span class="n">β</span><span class="o">]</span>

<span class="n">def</span> <span class="n">total</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">sheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span><span class="bp">.</span><span class="n">total</span>

<span class="n">def</span> <span class="n">res&#39;</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">sheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span> <span class="bp">→</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span> <span class="o">:=</span> <span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span><span class="bp">.</span><span class="n">res&#39;</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">sheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">F</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="bp">_</span><span class="o">,</span> <span class="n">α</span> <span class="bp">→</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">,</span>
  <span class="n">coe</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">F</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">sheaf</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">U</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span> <span class="n">has_coe_t</span> <span class="o">(</span><span class="n">F</span> <span class="n">U</span><span class="o">)</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span> <span class="o">:=</span>
<span class="bp">⟨</span><span class="n">sigma</span><span class="bp">.</span><span class="n">mk</span> <span class="bp">_⟩</span>

<span class="n">def</span> <span class="n">comap</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="err">↪⊓⨆</span> <span class="n">β</span><span class="o">)</span> <span class="o">(</span><span class="n">F</span> <span class="o">:</span> <span class="n">sheaf</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span> <span class="n">sheaf</span> <span class="n">α</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">locality</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">S</span> <span class="n">lub</span> <span class="o">(</span><span class="n">s</span> <span class="n">t</span> <span class="o">:</span> <span class="n">F</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">))</span> <span class="n">H</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">locality</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">map_lub</span> <span class="n">lub</span><span class="o">)</span> <span class="k">begin</span>
    <span class="n">rintro</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span> <span class="n">hb</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="k">let</span> <span class="n">G</span> <span class="o">:=</span> <span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span><span class="bp">.</span><span class="n">comap</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">),</span>
    <span class="k">have</span> <span class="o">:</span> <span class="n">G</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">b</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="o">(</span><span class="n">G</span> <span class="n">a</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">s</span><span class="o">)</span> <span class="bp">=</span>
           <span class="n">G</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">b</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="o">(</span><span class="n">G</span> <span class="n">a</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">t</span><span class="o">)</span> <span class="o">:=</span> <span class="n">H</span> <span class="n">b</span> <span class="n">hb</span><span class="o">,</span>
    <span class="k">have</span> <span class="n">H1</span> <span class="o">:=</span> <span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span><span class="bp">.</span><span class="n">comap_res&#39;</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="n">b</span> <span class="bp">_</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span><span class="o">,</span> <span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span><span class="bp">.</span><span class="n">comap_res&#39;</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">)</span> <span class="n">b</span><span class="o">]</span> <span class="n">at</span> <span class="n">H1</span><span class="o">,</span>
    <span class="n">simp</span> <span class="n">at</span> <span class="n">H1</span><span class="o">,</span> <span class="n">exact</span> <span class="n">H1</span><span class="bp">.</span><span class="n">symm</span>
  <span class="kn">end</span><span class="o">,</span>
  <span class="n">gluing</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">S</span> <span class="n">lub</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">U</span> <span class="o">:</span> <span class="n">S</span><span class="o">,</span> <span class="n">F</span> <span class="o">(</span><span class="n">f</span> <span class="n">U</span><span class="o">)),</span> <span class="k">begin</span>
    <span class="k">let</span> <span class="n">G</span> <span class="o">:=</span> <span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span><span class="bp">.</span><span class="n">comap</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">⊓</span> <span class="n">β</span><span class="o">),</span>
    <span class="n">change</span> <span class="bp">∀_</span><span class="o">:</span> <span class="bp">∀</span> <span class="n">V</span> <span class="n">W</span> <span class="o">:</span> <span class="n">S</span><span class="o">,</span> <span class="n">G</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="o">(</span><span class="n">V</span> <span class="err">⊓</span> <span class="n">W</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="o">(</span><span class="n">G</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">g</span> <span class="n">V</span><span class="o">))</span> <span class="bp">=</span>
                          <span class="n">G</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="o">(</span><span class="n">V</span> <span class="err">⊓</span> <span class="n">W</span><span class="o">)</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="o">(</span><span class="n">G</span> <span class="n">W</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">g</span> <span class="n">W</span><span class="o">)),</span>
      <span class="bp">∃</span> <span class="n">U</span> <span class="o">:</span> <span class="n">F</span> <span class="o">(</span><span class="n">f</span> <span class="n">a</span><span class="o">),</span> <span class="bp">∀</span> <span class="n">V</span> <span class="o">:</span> <span class="n">S</span><span class="o">,</span> <span class="n">G</span><span class="bp">.</span><span class="n">res&#39;</span> <span class="n">V</span> <span class="o">(</span><span class="bp">@</span><span class="n">coe</span> <span class="o">(</span><span class="n">G</span> <span class="n">a</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">U</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">@</span><span class="n">coe</span> <span class="o">(</span><span class="n">G</span> <span class="n">V</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">(</span><span class="n">g</span> <span class="n">V</span><span class="o">),</span>
    <span class="n">choose</span> <span class="n">k</span> <span class="n">hk</span> <span class="kn">using</span> <span class="k">show</span> <span class="bp">∀</span> <span class="n">V</span> <span class="o">:</span> <span class="n">f</span> <span class="err">&#39;&#39;</span> <span class="n">S</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">U</span> <span class="o">:</span> <span class="n">S</span><span class="o">,</span> <span class="o">(</span><span class="n">V</span><span class="o">:</span><span class="n">β</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">U</span><span class="o">,</span>
    <span class="k">by</span> <span class="n">rintro</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">exact</span> <span class="bp">⟨⟨</span><span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="k">let</span> <span class="n">g&#39;</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">V</span> <span class="o">:</span> <span class="n">f</span> <span class="err">&#39;&#39;</span> <span class="n">S</span><span class="o">,</span> <span class="n">F</span> <span class="o">(</span><span class="n">V</span><span class="o">:</span><span class="n">β</span><span class="o">)</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">V</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">hk</span> <span class="n">V</span><span class="bp">;</span> <span class="n">exact</span> <span class="n">g</span> <span class="o">(</span><span class="n">k</span> <span class="n">V</span><span class="o">),</span>
    <span class="k">have</span> <span class="n">g&#39;eq</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">U</span> <span class="o">(</span><span class="n">hU</span> <span class="o">:</span> <span class="n">U</span> <span class="err">∈</span> <span class="n">S</span><span class="o">),</span> <span class="o">(</span><span class="n">g&#39;</span> <span class="bp">⟨</span><span class="n">f</span> <span class="n">U</span><span class="o">,</span> <span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span> <span class="o">:</span> <span class="n">F</span><span class="bp">.</span><span class="n">total</span><span class="o">)</span> <span class="bp">=</span> <span class="n">g</span> <span class="bp">⟨</span><span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">intros</span><span class="o">,</span>
      <span class="n">suffices</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">U&#39;</span> <span class="o">(</span><span class="n">h&#39;</span> <span class="o">:</span> <span class="n">U&#39;</span> <span class="bp">=</span> <span class="n">k</span> <span class="bp">⟨</span><span class="n">f</span> <span class="n">U</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">),</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rw</span> <span class="n">h&#39;</span><span class="bp">;</span> <span class="n">exact</span> <span class="n">g</span> <span class="o">(</span><span class="n">k</span> <span class="bp">⟨</span><span class="n">f</span> <span class="n">U</span><span class="o">,</span> <span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">:</span> <span class="n">F</span> <span class="o">(</span><span class="n">f</span> <span class="n">U&#39;</span><span class="o">))</span> <span class="bp">=</span> <span class="n">g</span> <span class="n">U&#39;</span><span class="o">,</span>
      <span class="o">{</span> <span class="n">congr</span><span class="o">,</span> <span class="n">exact</span> <span class="n">this</span> <span class="bp">⟨</span><span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="bp">⟩</span> <span class="o">(</span><span class="n">subtype</span><span class="bp">.</span><span class="n">eq</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">inj</span> <span class="o">(</span><span class="n">hk</span> <span class="bp">⟨</span><span class="n">f</span> <span class="n">U</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">)))</span> <span class="o">},</span>
      <span class="n">rintro</span> <span class="bp">_</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="n">intro</span> <span class="n">h</span><span class="o">,</span>
    <span class="n">cases</span> <span class="n">F</span><span class="bp">.</span><span class="n">gluing</span> <span class="o">(</span><span class="n">f</span><span class="bp">.</span><span class="n">map_lub</span> <span class="n">lub</span><span class="o">)</span> <span class="n">g&#39;</span> <span class="bp">_</span> <span class="k">with</span> <span class="n">z</span> <span class="n">hz</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">use</span> <span class="n">z</span><span class="o">,</span> <span class="n">rintro</span> <span class="bp">⟨</span><span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="bp">⟩</span><span class="o">,</span>
      <span class="n">apply</span> <span class="n">presheaf</span><span class="bp">.</span><span class="n">comap_coe_inj</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">f</span><span class="bp">.</span><span class="n">inj</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">presheaf</span><span class="bp">.</span><span class="n">comap_res&#39;</span><span class="o">],</span>
      <span class="n">exact</span> <span class="o">(</span><span class="n">hz</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">U</span><span class="o">,</span> <span class="n">hU</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">g&#39;eq</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rintro</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">V</span><span class="o">,</span> <span class="n">hV</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="n">W</span><span class="o">,</span> <span class="n">hW</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
      <span class="k">have</span> <span class="o">:=</span> <span class="n">congr_arg</span> <span class="n">coe</span> <span class="o">(</span><span class="n">h</span> <span class="bp">⟨</span><span class="n">V</span><span class="o">,</span> <span class="n">hV</span><span class="bp">⟩</span> <span class="bp">⟨</span><span class="n">W</span><span class="o">,</span> <span class="n">hW</span><span class="bp">⟩</span><span class="o">),</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">presheaf</span><span class="bp">.</span><span class="n">comap_res&#39;</span><span class="o">,</span> <span class="n">presheaf</span><span class="bp">.</span><span class="n">comap_res&#39;</span><span class="o">]</span> <span class="n">at</span> <span class="n">this</span><span class="o">,</span>
      <span class="n">simp</span> <span class="n">at</span> <span class="n">this</span><span class="o">,</span> <span class="n">rwa</span> <span class="o">[</span><span class="err">←</span> <span class="n">g&#39;eq</span><span class="o">,</span> <span class="err">←</span> <span class="n">g&#39;eq</span><span class="o">]</span> <span class="n">at</span> <span class="n">this</span> <span class="o">}</span>
  <span class="kn">end</span><span class="o">,</span>
  <span class="bp">..</span><span class="n">F</span><span class="bp">.</span><span class="n">to_presheaf</span><span class="bp">.</span><span class="n">comap</span> <span class="n">f</span><span class="bp">.</span><span class="n">to_semilattice_inf_hom</span> <span class="o">}</span>

<span class="kn">end</span> <span class="n">sheaf</span>
</pre></div>

<a name="183453858"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183453858" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183453858">Bryan Gin-ge Chen (Dec 14 2019 at 19:08)</a>:</h4>
<p>(deleted)</p>

<a name="183459072"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183459072" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183459072">Julian Gilbey (Dec 14 2019 at 21:23)</a>:</h4>
<blockquote>
<p>The thing that makes <code>lift_beta</code> work is called the computation rule for <code>quot</code> and it's also magically added by <code>init_quotient</code></p>
</blockquote>
<p>Thanks <span class="user-mention" data-user-id="110032">@Reid Barton</span>  - that makes a lot of sense. The relevant section of Theorem Proving in Lean doesn't explain this point, though I've just found that in the <a href="https://leanprover.github.io/reference/expressions.html#axioms" target="_blank" title="https://leanprover.github.io/reference/expressions.html#axioms">reference manual</a>, it says explicitly: <code>quot.mk</code> and <code>quot.lift</code> satisfy the following computation rule:</p>
<div class="codehilite"><pre><span></span><span class="n">quot</span><span class="bp">.</span><span class="n">lift</span> <span class="n">f</span> <span class="n">h</span> <span class="o">(</span><span class="n">quot</span><span class="bp">.</span><span class="n">mk</span> <span class="n">r</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">f</span> <span class="n">a</span>
</pre></div>


<p>So this interpretation does seem to be built into the core (though I couldn't locate the actual code which does so).</p>

<a name="183459992"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183459992" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183459992">Bryan Gin-ge Chen (Dec 14 2019 at 21:53)</a>:</h4>
<p>The Lean code is <a href="https://github.com/leanprover-community/lean/blob/ec1613aef1eee72e601f192b16740629c6d49690/library/init/core.lean#L151" target="_blank" title="https://github.com/leanprover-community/lean/blob/ec1613aef1eee72e601f192b16740629c6d49690/library/init/core.lean#L151">here</a>, but as you can see that just calls a special <code>init_quotient</code> function which eventually calls <a href="https://github.com/leanprover/lean/blob/ec1613aef1eee72e601f192b16740629c6d49690/src/kernel/quotient/quotient.cpp#L73" target="_blank" title="https://github.com/leanprover/lean/blob/ec1613aef1eee72e601f192b16740629c6d49690/src/kernel/quotient/quotient.cpp#L73">this C++ function</a>.</p>

<a name="183460629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183460629" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183460629">Kevin Buzzard (Dec 14 2019 at 22:13)</a>:</h4>
<p>Yes the computation rule is a definitional equality by Leo's clever definition of <code>rfl</code>. This is precisely what falls if you roll your own</p>

<a name="183460843"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183460843" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183460843">Julian Gilbey (Dec 14 2019 at 22:19)</a>:</h4>
<p>Yes, I found that C++ function, but I don't understand how the computation rule was implied by it :-(  Anyway, knowing that it is definitionally built into Lean means I can stop worrying about it ;-)</p>

<a name="183462616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183462616" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183462616">Mario Carneiro (Dec 14 2019 at 23:10)</a>:</h4>
<p>The computation rule comes from the implementation of <code>quotient_normalizer_extension::operator()</code> in the same file</p>

<a name="183462629"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183462629" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183462629">Mario Carneiro (Dec 14 2019 at 23:11)</a>:</h4>
<p>it is an extension to the whnf function that checks if the target has the form <code>@quot.lift α r β f h (@quot.mk α r a)</code> and replaces it with <code>f a</code></p>

<a name="183462737"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/113489-new%20members/topic/How%20does%20quot%20work%3F/near/183462737" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/113489newmembers/96869Howdoesquotwork.html#183462737">Mario Carneiro (Dec 14 2019 at 23:14)</a>:</h4>
<p>It also reduces <code>@quot.ind α r β f (@quot.mk α r a)</code> to <code>f a</code>, even though this is mostly unnecessary because of proof irrelevance</p>


{% endraw %}

{% include archive_update.html %}