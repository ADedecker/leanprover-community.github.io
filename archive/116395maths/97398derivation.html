---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/116395maths/97398derivation.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/116395maths/index.html">maths</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html">derivation</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="170730598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170730598" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170730598">Kenny Lau (Jul 12 2019 at 15:21)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">algebra</span>

<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">u₁</span> <span class="n">v₁</span> <span class="n">w₁</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">A</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">R</span> <span class="n">A</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">)</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">A</span> <span class="n">M</span><span class="o">]</span>

<span class="c1">-- include R A</span>
<span class="c1">-- def module.comap := M</span>
<span class="c1">-- omit R A</span>

<span class="c1">-- def module.to_comap : M → module.comap R A M := id</span>
<span class="c1">-- def module.of_comap : module.comap R A M → M := id</span>

<span class="c1">-- namespace module.comap</span>

<span class="c1">-- instance : add_comm_group (module.comap R A M) := _inst_4</span>

<span class="c1">-- instance module_right : module A (module.comap R A M) := _inst_5</span>

<span class="c1">-- instance module_left : module R (module.comap R A M) :=</span>
<span class="c1">-- { smul := λ r m, module.to_comap R A M (algebra_map A r • module.of_comap R A M m),</span>
<span class="c1">--   one_smul := λ m, show module.to_comap R A M (algebra_map A (1:R) • module.of_comap R A M m) = m,</span>
<span class="c1">--     by rw [algebra.map_one, one_smul]; refl,</span>
<span class="c1">--   mul_smul := λ r1 r2 m, show module.to_comap R A M (algebra_map A _ • _) = _,</span>
<span class="c1">--     by rw [algebra.map_mul, mul_smul]; refl,</span>
<span class="c1">--   smul_add := λ r m1 m2, by convert smul_add (algebra_map A r) (module.of_comap R A M m1) (module.of_comap R A M m2),</span>
<span class="c1">--   smul_zero := λ r, by convert smul_zero (algebra_map A r),</span>
<span class="c1">--   add_smul := λ r1 r2 m, show module.to_comap R A M (algebra_map A _ • _) = _,</span>
<span class="c1">--     by rw [algebra.map_add, add_smul]; refl,</span>
<span class="c1">--   zero_smul := λ m, show module.to_comap R A M (algebra_map A (0:R) • module.of_comap R A M m) = 0,</span>
<span class="c1">--     by rw [algebra.map_zero, zero_smul]; refl }</span>

<span class="c1">-- end module.comap</span>

<span class="kn">structure</span> <span class="n">derivation</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→</span> <span class="n">M</span><span class="o">)</span>
<span class="o">(</span><span class="n">add</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">to_fun</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">to_fun</span> <span class="n">y</span><span class="o">)</span>
<span class="o">(</span><span class="n">mul</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">x</span> <span class="err">•</span> <span class="n">to_fun</span> <span class="n">y</span> <span class="bp">+</span> <span class="n">y</span> <span class="err">•</span> <span class="n">to_fun</span> <span class="n">x</span><span class="o">)</span>
<span class="o">(</span><span class="n">algebra</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span> <span class="n">r</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_comm₄</span><span class="o">]</span>
<span class="kn">theorem</span> <span class="n">mul_comm₄</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="bp">*</span> <span class="o">(</span><span class="n">c</span> <span class="bp">*</span> <span class="n">d</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">*</span> <span class="o">(</span><span class="n">b</span> <span class="bp">*</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mul_assoc</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">mul_left_comm</span> <span class="n">b</span><span class="o">]</span>

<span class="kn">namespace</span> <span class="n">derivation</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">⟨λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">A</span> <span class="bp">→</span> <span class="n">M</span><span class="o">,</span> <span class="n">derivation</span><span class="bp">.</span><span class="n">to_fun</span><span class="bp">⟩</span>

<span class="kn">section</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span>
<span class="kn">theorem</span> <span class="n">map_add</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">+</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">D</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">D</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">D</span><span class="bp">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">b</span>
<span class="kn">theorem</span> <span class="n">map_zero</span> <span class="o">:</span> <span class="n">D</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="bp">@@</span><span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_zero</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">D</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>
<span class="kn">theorem</span> <span class="n">map_neg</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="bp">-</span><span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">-</span><span class="n">D</span> <span class="n">a</span> <span class="o">:=</span> <span class="bp">@@</span><span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_neg</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">D</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span> <span class="bp">_</span>
<span class="kn">theorem</span> <span class="n">map_sub</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">-</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">D</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">D</span> <span class="n">b</span> <span class="o">:=</span> <span class="bp">@@</span><span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_sub</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">D</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span> <span class="bp">_</span> <span class="bp">_</span>
<span class="kn">theorem</span> <span class="n">map_mul</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">b</span> <span class="err">•</span> <span class="n">D</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">D</span><span class="bp">.</span><span class="n">mul</span> <span class="n">a</span> <span class="n">b</span>
<span class="kn">theorem</span> <span class="n">map_mul_comm</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span> <span class="err">•</span> <span class="n">D</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">b</span> <span class="o">:=</span> <span class="o">(</span><span class="n">D</span><span class="bp">.</span><span class="n">mul</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span><span class="bp">.</span><span class="n">trans</span> <span class="err">$</span> <span class="n">add_comm</span> <span class="bp">_</span> <span class="bp">_</span>
<span class="kn">theorem</span> <span class="n">map_algebra_map</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span> <span class="n">r</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">D</span><span class="bp">.</span><span class="n">algebra</span> <span class="n">r</span>

<span class="bp">@</span><span class="o">[</span><span class="n">extensionality</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">ext</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">{</span><span class="n">D1</span> <span class="n">D2</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">},</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">a</span><span class="o">,</span> <span class="n">D1</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">D2</span> <span class="n">a</span><span class="o">)</span> <span class="bp">→</span> <span class="n">D1</span> <span class="bp">=</span> <span class="n">D2</span>
<span class="bp">|</span> <span class="bp">⟨</span><span class="n">f</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span> <span class="bp">⟨</span><span class="n">g</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span> <span class="n">H</span> <span class="o">:=</span> <span class="n">mk</span><span class="bp">.</span><span class="n">inj_eq</span><span class="bp">.</span><span class="n">mpr</span> <span class="err">$</span> <span class="n">funext</span> <span class="n">H</span>
<span class="kn">end</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="o">(</span><span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine</span>
<span class="o">{</span> <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D1</span> <span class="n">D2</span><span class="o">,</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">D1</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">D2</span> <span class="n">a</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D1</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">D2</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D1</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">D2</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D1</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">D2</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">zero</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">add_zero</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">smul_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">neg</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="bp">-</span><span class="n">D</span> <span class="n">a</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">neg_add</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">neg_add</span><span class="o">,</span> <span class="n">smul_neg</span><span class="o">,</span> <span class="n">smul_neg</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">]</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="bp">..</span> <span class="o">}</span><span class="bp">;</span>
<span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">ext</span><span class="o">,</span> <span class="n">exact</span> <span class="n">add_assoc</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span> <span class="n">exact</span> <span class="n">zero_add</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span>
  <span class="n">exact</span> <span class="n">add_zero</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span> <span class="n">exact</span> <span class="n">add_left_neg</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span> <span class="n">exact</span> <span class="n">add_comm</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">module</span> <span class="n">A</span> <span class="o">(</span><span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">D</span><span class="o">,</span> <span class="bp">⟨λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">b</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">smul_zero</span><span class="o">]</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">mul_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">mul_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">one_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">one_smul</span> <span class="n">A</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul_add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">D1</span> <span class="n">D2</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">smul_add</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul_zero</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">smul_zero</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">add_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">add_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">zero_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">zero_smul</span> <span class="n">A</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">section</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="o">(</span><span class="n">D</span> <span class="n">D1</span> <span class="n">D2</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">add_apply</span> <span class="o">:</span> <span class="o">(</span><span class="n">D1</span> <span class="bp">+</span> <span class="n">D2</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">D1</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">D2</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">zero_apply</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">neg_apply</span> <span class="o">:</span> <span class="o">(</span><span class="bp">-</span><span class="n">D</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="bp">-</span><span class="o">(</span><span class="n">D</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">sub_apply</span> <span class="o">:</span> <span class="o">(</span><span class="n">D1</span> <span class="bp">-</span> <span class="n">D2</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">D1</span> <span class="n">b</span> <span class="bp">-</span> <span class="n">D2</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="kn">set_option</span> <span class="n">class</span><span class="bp">.</span><span class="n">instance_max_depth</span> <span class="mi">41</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">smul_apply</span> <span class="o">:</span> <span class="o">(</span><span class="n">a</span> <span class="err">•</span> <span class="n">D</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="err">•</span> <span class="o">(</span><span class="n">D</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="kn">end</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span>
<span class="n">def</span> <span class="n">comp</span> <span class="o">{</span><span class="n">N</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u₁</span><span class="o">}</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">N</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">A</span> <span class="n">N</span><span class="o">]</span>
  <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">M</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">N</span><span class="o">)</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">N</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">f</span> <span class="o">(</span><span class="n">D</span> <span class="n">a</span><span class="o">),</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_add</span><span class="o">],</span>
  <span class="n">mul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">],</span>
  <span class="n">algebra</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_zero</span><span class="o">]</span> <span class="o">}</span>

<span class="kn">end</span> <span class="n">derivation</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">R</span> <span class="n">A</span><span class="o">)</span>

<span class="n">def</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">relators</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">free_abelian_group</span> <span class="o">(</span><span class="n">A</span> <span class="bp">×</span> <span class="n">A</span><span class="o">))</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">x</span> <span class="o">:</span> <span class="n">free_abelian_group</span> <span class="o">(</span><span class="n">A</span> <span class="bp">×</span> <span class="n">A</span><span class="o">)</span> <span class="bp">|</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">+</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="bp">+</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="bp">∨</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="bp">+</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="bp">∨</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="bp">+</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">,</span> <span class="n">b</span><span class="o">))</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="bp">∨</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">algebra_map</span> <span class="n">A</span> <span class="n">r</span><span class="o">)</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="o">}</span>

<span class="n">def</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span> <span class="o">:=</span>
<span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">quotient</span> <span class="err">$</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">closure</span> <span class="err">$</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">relators</span> <span class="n">R</span> <span class="n">A</span>

<span class="kn">namespace</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="bp">_</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">normal_add_subgroup</span> <span class="o">(</span><span class="n">add_group</span><span class="bp">.</span><span class="n">closure</span> <span class="o">(</span><span class="n">relators</span> <span class="n">R</span> <span class="n">A</span><span class="o">))</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">normal</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span> <span class="n">hn</span> <span class="n">g</span><span class="o">,</span> <span class="k">by</span> <span class="n">rwa</span> <span class="n">add_sub_cancel&#39;</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_scalar</span> <span class="n">A</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span>
    <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">×</span> <span class="n">A</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="err">$</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span><span class="o">))</span> <span class="bp">_⟩</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span> <span class="n">refine</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">in_closure</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">hx</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">y</span> <span class="n">hy</span><span class="o">,</span> <span class="n">rcases</span> <span class="n">hy</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">|</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">|</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">|</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">r</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span>
          <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span>
          <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span>
          <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_assoc</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">_</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">y</span> <span class="n">hx</span> <span class="n">hy</span> <span class="n">ihx</span> <span class="n">ihy</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihx</span><span class="o">,</span> <span class="n">ihy</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">module</span> <span class="n">A</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="o">(</span><span class="err">•</span><span class="o">),</span> <span class="bp">..</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">rw</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">a1</span> <span class="n">a2</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">],</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span>
          <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_assoc</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span>
        <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)],</span> <span class="n">apply_instance</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">exact</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span><span class="o">,</span> <span class="n">exact</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_zero</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span> <span class="n">s</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">],</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="o">(</span><span class="bp">_</span> <span class="o">:</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">)),</span> <span class="n">rw</span> <span class="n">add_comm</span><span class="o">,</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_add</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">],</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">zero_mul</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="o">(</span><span class="bp">_</span> <span class="o">:</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">),</span> <span class="n">rw</span> <span class="n">add_zero</span><span class="o">,</span>
      <span class="n">refine</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">p2</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">),</span>
      <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">sub_sub</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">,</span> <span class="n">zero_sub</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]</span> <span class="o">}</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>

<a name="170730675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170730675" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170730675">Kenny Lau (Jul 12 2019 at 15:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="err">$</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">a</span><span class="o">),</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="err">$</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="err">$</span> <span class="k">show</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span>
    <span class="k">by</span> <span class="n">rw</span> <span class="n">add_comm</span><span class="bp">;</span> <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">),</span>
  <span class="n">mul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)]</span><span class="bp">;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">mul_comm</span> <span class="bp">_</span> <span class="o">(</span><span class="mi">1</span><span class="o">:</span><span class="n">A</span><span class="o">)]</span><span class="bp">;</span>
    <span class="n">exact</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="err">$</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨</span><span class="mi">1</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">sub_eq_neg_add</span><span class="bp">⟩</span><span class="o">),</span>
  <span class="n">algebra</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="err">$</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="err">$</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="bp">⟨</span><span class="mi">1</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">]</span><span class="bp">⟩</span> <span class="o">}</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span><span class="o">}</span>

<span class="kn">theorem</span> <span class="n">smul_D</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">R</span> <span class="n">A</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">))</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">),</span> <span class="n">D</span><span class="o">]</span><span class="bp">;</span> <span class="n">erw</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>

<span class="bp">@</span><span class="o">[</span><span class="n">elab_as_eliminator</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">induction_on</span> <span class="o">{</span><span class="n">C</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hd</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="o">((</span><span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="err">•</span> <span class="n">D</span> <span class="n">R</span> <span class="n">A</span> <span class="n">b</span><span class="o">))</span> <span class="o">(</span><span class="n">ha</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">C</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">C</span> <span class="o">(</span><span class="n">a</span><span class="bp">+</span><span class="n">b</span><span class="o">))</span> <span class="o">:</span> <span class="n">C</span> <span class="n">p</span> <span class="o">:=</span>
<span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
  <span class="o">(</span><span class="k">by</span> <span class="n">simpa</span> <span class="n">only</span> <span class="o">[</span><span class="n">zero_smul</span><span class="o">]</span> <span class="kn">using</span> <span class="n">hd</span> <span class="mi">0</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="bp">⟩</span><span class="o">,</span> <span class="k">by</span> <span class="k">have</span> <span class="o">:=</span> <span class="n">hd</span> <span class="n">a</span> <span class="n">b</span><span class="bp">;</span> <span class="n">rwa</span> <span class="n">smul_D</span> <span class="n">at</span> <span class="n">this</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="bp">⟩</span> <span class="n">ih</span><span class="o">,</span> <span class="k">by</span> <span class="k">have</span> <span class="o">:=</span> <span class="n">hd</span> <span class="o">(</span><span class="bp">-</span><span class="n">a</span><span class="o">)</span> <span class="n">b</span><span class="bp">;</span> <span class="n">rwa</span> <span class="o">[</span><span class="n">neg_smul</span><span class="o">,</span> <span class="n">smul_D</span><span class="o">]</span> <span class="n">at</span> <span class="n">this</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="n">ha</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span>

<span class="bp">@</span><span class="o">[</span><span class="n">elab_as_eliminator</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">induction_on&#39;</span> <span class="o">{</span><span class="n">C</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hd</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="err">$</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)))</span> <span class="o">(</span><span class="n">ha</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">C</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">C</span> <span class="o">(</span><span class="n">a</span><span class="bp">+</span><span class="n">b</span><span class="o">))</span> <span class="o">:</span> <span class="n">C</span> <span class="n">p</span> <span class="o">:=</span>
<span class="n">induction_on</span> <span class="n">p</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">smul_D</span><span class="bp">;</span> <span class="n">apply</span> <span class="n">hd</span><span class="o">)</span> <span class="n">ha</span>

<span class="kn">end</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span>

<span class="kn">namespace</span> <span class="n">derivation</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span>

<span class="n">def</span> <span class="n">factor</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">M</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span> <span class="err">•</span> <span class="n">D</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span><span class="o">)</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span>
    <span class="n">add_group</span><span class="bp">.</span><span class="n">in_closure</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">hx</span>
      <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">hp</span><span class="o">,</span> <span class="n">or</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">hp</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">add_smul</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">])</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">hp</span><span class="o">,</span> <span class="n">or</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">hp</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">])</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">hp</span><span class="o">,</span> <span class="n">or</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">hp</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">])</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">r</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">smul_zero</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">]))</span>
      <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">_</span><span class="o">)</span>
      <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">hp</span> <span class="n">ih</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">])</span>
      <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">hp</span> <span class="n">hq</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]),</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_smul</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">smul_D</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span>
        <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">smul_D</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">])</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">q</span> <span class="n">r</span> <span class="n">ihq</span> <span class="n">ihr</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_add</span><span class="o">,</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">ihr</span><span class="o">,</span>
        <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">smul_add</span><span class="o">]</span><span class="bp">;</span> <span class="n">apply_instance</span><span class="o">)</span> <span class="o">}</span>

<span class="kn">theorem</span> <span class="n">factor_comp</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor</span> <span class="bp">=</span> <span class="n">D</span> <span class="o">:=</span>
<span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[</span><span class="n">comp</span><span class="o">,</span> <span class="n">factor</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span><span class="o">,</span> <span class="n">coe_fn</span><span class="o">,</span> <span class="n">has_coe_to_fun</span><span class="bp">.</span><span class="n">coe</span><span class="o">]</span><span class="bp">;</span>
<span class="n">erw</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">one_smul</span><span class="o">]</span>

<span class="kn">theorem</span> <span class="n">factor_D</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">D</span> <span class="n">a</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">conv_rhs</span> <span class="o">{</span> <span class="n">rw</span> <span class="err">←</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor_comp</span> <span class="o">}</span><span class="bp">;</span> <span class="n">refl</span>

<span class="kn">theorem</span> <span class="n">comp_factor</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">M</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">factor</span> <span class="bp">=</span> <span class="n">f</span> <span class="o">:=</span>
<span class="n">linear_map</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on&#39;</span> <span class="n">p</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[</span><span class="n">comp</span><span class="o">,</span> <span class="n">factor</span><span class="o">,</span> <span class="n">coe_fn</span><span class="o">,</span> <span class="n">has_coe_to_fun</span><span class="bp">.</span><span class="n">coe</span><span class="o">]</span><span class="bp">;</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="err">←</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">smul_D</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">smul</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">f</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">])</span>

<span class="n">def</span> <span class="n">linear_equiv</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span> <span class="err">≃ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">factor</span><span class="o">,</span>
  <span class="n">inv_fun</span> <span class="o">:=</span> <span class="n">comp</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span><span class="o">),</span>
  <span class="n">left_inv</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor_comp</span><span class="o">,</span>
  <span class="n">right_inv</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">comp_factor</span> <span class="n">f</span><span class="o">,</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D1</span> <span class="n">D2</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span>
        <span class="n">factor_D</span><span class="o">,</span> <span class="n">factor_D</span><span class="o">,</span> <span class="n">factor_D</span><span class="o">,</span> <span class="n">derivation</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">])</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">]),</span>
  <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">D</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">smul_apply</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span>
        <span class="n">factor_D</span><span class="o">,</span> <span class="n">factor_D</span><span class="o">,</span> <span class="n">derivation</span><span class="bp">.</span><span class="n">smul_apply</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">])</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">])</span> <span class="o">}</span>

<span class="kn">end</span> <span class="n">derivation</span>

<span class="bp">@</span><span class="o">[</span><span class="n">monotonicity</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">to_finset_mono</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span>
  <span class="o">{</span><span class="n">m₁</span> <span class="n">m₂</span> <span class="o">:</span> <span class="n">multiset</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">m₁</span> <span class="err">⊆</span> <span class="n">m₂</span><span class="o">)</span> <span class="o">:</span> <span class="n">m₁</span><span class="bp">.</span><span class="n">to_finset</span> <span class="err">⊆</span> <span class="n">m₂</span><span class="bp">.</span><span class="n">to_finset</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">]</span><span class="bp">;</span> <span class="n">exact</span> <span class="bp">@</span><span class="n">h</span> <span class="n">i</span>

<span class="kn">namespace</span> <span class="n">finsupp</span>

<span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">to_has_scalar&#39;</span>
<span class="kn">lemma</span> <span class="n">sum_smul_index&#39;</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">[</span><span class="n">semiring</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">add_comm_monoid</span> <span class="n">γ</span><span class="o">]</span> <span class="o">{</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">₀</span> <span class="n">β</span><span class="o">}</span> <span class="o">{</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">}</span> <span class="o">{</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">}</span>
  <span class="o">(</span><span class="n">h0</span> <span class="o">:</span> <span class="bp">∀</span><span class="n">i</span><span class="o">,</span> <span class="n">h</span> <span class="n">i</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">b</span> <span class="err">•</span> <span class="n">g</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">h</span> <span class="bp">=</span> <span class="n">g</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span><span class="n">i</span> <span class="n">a</span><span class="o">,</span> <span class="n">h</span> <span class="n">i</span> <span class="o">(</span><span class="n">b</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))</span> <span class="o">:=</span>
<span class="n">sum_map_range_index</span> <span class="n">h0</span>

<span class="kn">lemma</span> <span class="n">single_eq_smul_one</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">single</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="err">•</span> <span class="n">single</span> <span class="n">a</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_single</span><span class="o">,</span> <span class="n">smul_eq_mul</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>

<span class="kn">end</span> <span class="n">finsupp</span>

<span class="kn">namespace</span> <span class="n">mv_polynomial</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">σ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">σ</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">i</span> <span class="n">j</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span>

<span class="n">def</span> <span class="n">partial_deriv</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span> <span class="o">:=</span>
<span class="c1">-- p.sum $ λ v r, C r * (add_monoid.smul (v i) (X i ^ (v i - 1)) * v.prod (λ j n, if i = j then 1 else (mv_polynomial.X j)^n))</span>
<span class="n">p</span><span class="bp">.</span><span class="n">sum</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">v</span> <span class="n">r</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="o">(</span><span class="n">v</span><span class="bp">.</span><span class="n">sum</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">j</span> <span class="n">n</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">j</span> <span class="o">(</span><span class="k">if</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">j</span> <span class="k">then</span> <span class="n">n</span><span class="bp">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">n</span><span class="o">))</span> <span class="o">(</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul</span> <span class="o">(</span><span class="n">v</span> <span class="n">i</span><span class="o">)</span> <span class="n">r</span><span class="o">)</span>

<span class="c1">-- #exit</span>
<span class="kn">theorem</span> <span class="n">partial_deriv_add</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">+</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">+</span> <span class="n">q</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="o">:=</span>
<span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">v</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span><span class="o">)</span> <span class="err">$</span>
<span class="bp">λ</span> <span class="n">v</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_add</span><span class="o">]</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_zero</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_zero_index</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_C</span> <span class="o">:</span> <span class="o">(</span><span class="n">C</span> <span class="n">r</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span> <span class="err">$</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span><span class="o">)</span><span class="bp">.</span><span class="n">trans</span> <span class="err">$</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">zero_apply</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_X</span> <span class="o">:</span> <span class="o">(</span><span class="n">X</span> <span class="n">i</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">j</span> <span class="bp">=</span> <span class="k">if</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">j</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">X</span><span class="o">,</span> <span class="n">monomial</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">sub_self</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">],</span>
  <span class="o">{</span> <span class="n">split_ifs</span> <span class="k">with</span> <span class="n">hji</span> <span class="n">hij</span> <span class="n">hij</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">one_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">exact</span> <span class="n">absurd</span> <span class="n">hji</span><span class="bp">.</span><span class="n">symm</span> <span class="n">hij</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">exact</span> <span class="n">absurd</span> <span class="n">hij</span><span class="bp">.</span><span class="n">symm</span> <span class="n">hji</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">split_ifs</span> <span class="k">with</span> <span class="n">hji</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">zero_sub</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_one</span> <span class="o">:</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">C_1</span><span class="o">,</span> <span class="n">partial_deriv_C</span><span class="o">]</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">to_semimodule</span> <span class="bp">_</span> <span class="bp">_</span>

<span class="kn">theorem</span> <span class="n">C_mul&#39;&#39;</span> <span class="o">:</span> <span class="n">C</span> <span class="n">r</span> <span class="bp">*</span> <span class="n">p</span> <span class="bp">=</span> <span class="n">r</span> <span class="err">•</span> <span class="n">p</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">p</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="o">(</span><span class="n">mul_zero</span> <span class="bp">_</span><span class="o">)</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">smul_zero</span> <span class="bp">_</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span> <span class="n">s</span> <span class="n">f</span> <span class="n">hfv</span> <span class="n">hs</span> <span class="n">ih</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">C</span><span class="o">,</span> <span class="n">monomial</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">mul_def</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">smul_single</span><span class="o">,</span> <span class="n">smul_eq_mul</span><span class="o">],</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">]</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">zero_mul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">}</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_smul</span> <span class="o">:</span> <span class="o">(</span><span class="n">r</span> <span class="err">•</span> <span class="n">p</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">r</span> <span class="err">•</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_smul_index&#39;</span><span class="o">,</span> <span class="n">partial_deriv</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">mul_sum</span><span class="o">],</span> <span class="n">refine</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_congr</span> <span class="n">rfl</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span> <span class="n">hv</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_eq_mul</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_eq_mul</span><span class="o">,</span> <span class="n">mul_left_comm</span><span class="o">,</span> <span class="err">←</span> <span class="n">smul_eq_mul</span><span class="o">,</span> <span class="err">←</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">smul_single</span><span class="o">,</span> <span class="n">C_mul&#39;&#39;</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>

<a name="170730690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170730690" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170730690">Kenny Lau (Jul 12 2019 at 15:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">partial_deriv_mul</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">+</span> <span class="n">q</span> <span class="bp">*</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">v</span> <span class="n">w</span> <span class="o">:</span> <span class="n">σ</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="n">w</span> <span class="n">i</span> <span class="bp">≠</span> <span class="mi">0</span> <span class="bp">→</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="n">v</span> <span class="bp">+</span> <span class="n">w</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">j</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">j</span> <span class="o">(</span><span class="n">ite</span> <span class="o">(</span><span class="n">i</span> <span class="bp">=</span> <span class="n">j</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span><span class="o">)</span> <span class="n">n</span><span class="o">))</span> <span class="bp">=</span>
    <span class="n">v</span> <span class="bp">+</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span> <span class="n">w</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">j</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">j</span> <span class="o">(</span><span class="n">ite</span> <span class="o">(</span><span class="n">i</span> <span class="bp">=</span> <span class="n">j</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span><span class="o">)</span> <span class="n">n</span><span class="o">)),</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span> <span class="n">w</span> <span class="n">hw</span><span class="o">,</span> <span class="n">ext</span> <span class="n">j</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_single</span> <span class="n">j</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_single</span> <span class="n">j</span><span class="o">],</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">],</span> <span class="n">split_ifs</span> <span class="k">with</span> <span class="n">hij</span><span class="o">,</span>
      <span class="o">{</span> <span class="n">subst</span> <span class="n">hij</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">add_sub_assoc</span><span class="o">],</span> <span class="n">exact</span> <span class="n">nat</span><span class="bp">.</span><span class="n">one_le_of_lt</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="n">hw</span><span class="o">)</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">refl</span> <span class="o">}</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">k</span> <span class="n">hk</span> <span class="n">hkj</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">hkj</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">hjw</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">],</span> <span class="n">split_ifs</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">not_mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hjw</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">k</span> <span class="n">hk</span> <span class="n">hkj</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">hkj</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">hjw</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">],</span> <span class="n">split_ifs</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">not_mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hjw</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">refine</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">p</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">v</span> <span class="n">r</span> <span class="n">p</span> <span class="n">hpv</span> <span class="n">hr</span> <span class="n">ihp</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
  <span class="o">{</span> <span class="n">erw</span> <span class="n">zero_mul</span><span class="o">,</span> <span class="n">rw</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">erw</span> <span class="n">partial_deriv_zero</span><span class="o">,</span> <span class="n">rw</span> <span class="n">mul_zero</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_mul</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">],</span> <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="bp">_</span> <span class="n">ihp</span><span class="o">)</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_mul</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">refine</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">q</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">w</span> <span class="n">s</span> <span class="n">q</span> <span class="n">hqw</span> <span class="n">hs</span> <span class="n">ihq</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
  <span class="o">{</span> <span class="n">erw</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">rw</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">erw</span> <span class="n">zero_mul</span><span class="o">,</span> <span class="n">rw</span> <span class="n">partial_deriv_zero</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">],</span> <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="bp">_</span> <span class="n">ihq</span><span class="o">)</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_mul</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_mul_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_eq_smul_one</span> <span class="n">v</span> <span class="n">r</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_eq_smul_one</span> <span class="n">w</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_eq_smul_one</span> <span class="o">(</span><span class="n">v</span><span class="bp">+</span><span class="n">w</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span><span class="bp">*</span><span class="n">s</span><span class="o">)],</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv_smul</span><span class="o">,</span> <span class="n">partial_deriv_smul</span><span class="o">,</span> <span class="n">partial_deriv_smul</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">],</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">mul_comm₄</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul</span><span class="o">,</span> <span class="n">mul_comm₄</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul</span><span class="o">,</span> <span class="n">mul_comm</span> <span class="n">s</span> <span class="n">r</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_add</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_mul_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_mul_single</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">],</span>
  <span class="n">by_cases</span> <span class="n">hv</span> <span class="o">:</span> <span class="n">v</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">hv</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">erw</span> <span class="n">add_zero</span><span class="o">,</span>
    <span class="n">by_cases</span> <span class="n">hw</span> <span class="o">:</span> <span class="n">w</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">hw</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="n">v</span> <span class="n">w</span> <span class="n">hw</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">by_cases</span> <span class="n">hw</span> <span class="o">:</span> <span class="n">w</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">hw</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">],</span> <span class="n">erw</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_comm</span> <span class="n">v</span> <span class="n">w</span><span class="o">,</span> <span class="n">this</span> <span class="n">w</span> <span class="n">v</span> <span class="n">hv</span><span class="o">]</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">add_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_add</span><span class="o">,</span> <span class="n">add_comm</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="n">this</span> <span class="n">v</span> <span class="n">w</span> <span class="n">hw</span> <span class="o">},</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_comm</span> <span class="n">v</span> <span class="n">w</span><span class="o">,</span> <span class="n">this</span> <span class="n">w</span> <span class="n">v</span> <span class="n">hv</span><span class="o">]</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">theorem</span> <span class="n">vars_add</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">+</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">vars</span> <span class="err">⊆</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="k">by</span> <span class="n">unfold</span> <span class="n">vars</span><span class="bp">;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_union</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">]</span><span class="bp">;</span> <span class="n">exact</span>
<span class="bp">λ</span> <span class="n">hi</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_add</span><span class="bp">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span>
  <span class="o">(</span><span class="n">le_trans</span> <span class="o">(</span><span class="n">degrees_add</span> <span class="n">p</span> <span class="n">q</span><span class="o">)</span> <span class="err">$</span> <span class="n">lattice</span><span class="bp">.</span><span class="n">sup_le</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">le_add_right</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">le_add_left</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">))</span> <span class="n">hi</span><span class="o">)</span>

<span class="kn">theorem</span> <span class="n">vars_mul</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">vars</span> <span class="err">⊆</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="k">by</span> <span class="n">unfold</span> <span class="n">vars</span><span class="bp">;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_union</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">]</span><span class="bp">;</span> <span class="n">exact</span>
<span class="bp">λ</span> <span class="n">hi</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_add</span><span class="bp">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="o">(</span><span class="n">degrees_mul</span> <span class="n">p</span> <span class="n">q</span><span class="o">)</span> <span class="n">hi</span><span class="o">)</span>

<span class="kn">theorem</span> <span class="n">vars_X_subset</span> <span class="o">:</span> <span class="n">vars</span> <span class="o">(</span><span class="n">X</span> <span class="n">i</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="err">⊆</span> <span class="o">{</span><span class="n">i</span><span class="o">}</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">j</span> <span class="n">hj</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="o">(</span><span class="n">degrees_X</span> <span class="n">i</span><span class="o">)</span> <span class="err">$</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hj</span>

<span class="kn">theorem</span> <span class="n">of_not_mem_vars</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">i</span> <span class="err">∉</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">σ</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">hv</span> <span class="o">:</span> <span class="n">v</span> <span class="err">∈</span> <span class="n">p</span><span class="bp">.</span><span class="n">support</span><span class="o">)</span> <span class="o">:</span> <span class="n">v</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">finsupp</span><span class="bp">.</span><span class="n">not_mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">hiv</span><span class="o">,</span> <span class="n">h</span> <span class="err">$</span>
<span class="k">have</span> <span class="n">h1</span> <span class="o">:</span> <span class="n">v</span><span class="bp">.</span><span class="n">to_multiset</span> <span class="bp">≤</span> <span class="n">p</span><span class="bp">.</span><span class="n">degrees</span> <span class="o">:=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">le_sup</span> <span class="n">hv</span><span class="o">,</span>
<span class="k">have</span> <span class="n">h2</span> <span class="o">:</span> <span class="bp">_</span> <span class="bp">≤</span> <span class="n">v</span><span class="bp">.</span><span class="n">to_multiset</span> <span class="o">:=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">single_le_sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">zero_le</span> <span class="bp">_</span><span class="o">)</span> <span class="n">hiv</span><span class="o">,</span>
<span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="bp">.</span><span class="mi">2</span> <span class="err">$</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="n">h1</span> <span class="err">$</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="n">h2</span> <span class="err">$</span>
<span class="k">by</span> <span class="n">rw</span> <span class="err">←</span> <span class="n">nat</span><span class="bp">.</span><span class="n">succ_pred_eq_of_pos</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="err">$</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hiv</span><span class="o">)</span><span class="bp">;</span> <span class="n">exact</span>
<span class="n">multiset</span><span class="bp">.</span><span class="n">mem_cons_self</span> <span class="bp">_</span> <span class="bp">_</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_of_not_mem_vars</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">i</span> <span class="err">∉</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">:</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_zero</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">v</span> <span class="n">hv</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">of_not_mem_vars</span> <span class="n">i</span> <span class="n">p</span> <span class="n">h</span> <span class="n">v</span> <span class="n">hv</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span>

<span class="kn">end</span> <span class="n">mv_polynomial</span>

<span class="kn">namespace</span> <span class="n">derivation</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">σ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">σ</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span>

<span class="c">/-</span><span class="cm"> protected def mv_polynomial : derivation α (mv_polynomial σ α) (mv_polynomial σ α) :=</span>
<span class="cm">{ to_fun := mv_polynomial.partial_deriv i,</span>
<span class="cm">  add := mv_polynomial.partial_deriv_add i,</span>
<span class="cm">  mul := mv_polynomial.partial_deriv_mul i,</span>
<span class="cm">  algebra := mv_polynomial.partial_deriv_C i } -/</span>

<span class="kn">theorem</span> <span class="n">mv_polynomial_eval</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">ι</span><span class="o">]</span>
  <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">ι</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">D</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span><span class="o">)</span> <span class="bp">=</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span> <span class="err">•</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">))</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">p</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">ι</span> <span class="n">R</span><span class="o">,</span> <span class="bp">∀</span> <span class="n">q</span> <span class="o">:</span> <span class="n">finset</span> <span class="n">ι</span><span class="o">,</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">⊆</span> <span class="n">q</span> <span class="bp">→</span>
    <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span> <span class="err">•</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">))</span> <span class="bp">=</span>
    <span class="n">q</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span> <span class="err">•</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)),</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">hpq</span><span class="o">,</span> <span class="n">refine</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_subset</span> <span class="n">hpq</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="n">hiq</span> <span class="n">hip</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_of_not_mem_vars</span> <span class="n">i</span> <span class="n">p</span> <span class="n">hip</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">]</span> <span class="o">},</span>
  <span class="n">refine</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_C</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_C</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_add</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="n">p</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_left</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="n">q</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_right</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="o">(</span><span class="n">p</span><span class="bp">+</span><span class="n">q</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_add</span> <span class="n">p</span> <span class="n">q</span><span class="o">)],</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_add</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_add</span><span class="o">,</span> <span class="n">add_smul</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_add_distrib</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">i</span> <span class="n">ih</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_mul</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_X</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">X</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="o">{</span><span class="n">i</span><span class="o">})</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_mul</span> <span class="n">p</span> <span class="bp">_</span><span class="o">)</span>
        <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">union_subset</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_left</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span>
        <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_X_subset</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_right</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">))))],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">union_comm</span><span class="o">,</span> <span class="err">←</span> <span class="n">finset</span><span class="bp">.</span><span class="n">insert_eq</span><span class="o">],</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_mul</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_add</span><span class="o">,</span> <span class="n">add_smul</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_add_distrib</span><span class="o">],</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_mul</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_X</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_X</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">smul_sum</span><span class="o">],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">smul_smul</span><span class="o">],</span>
    <span class="n">by_cases</span> <span class="n">hip</span> <span class="o">:</span> <span class="n">i</span> <span class="err">∈</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">finset</span><span class="bp">.</span><span class="n">insert_eq_of_mem</span> <span class="n">hip</span><span class="o">,</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_single</span> <span class="n">i</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">],</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">j</span> <span class="n">hjp</span> <span class="n">hji</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">if_neg</span> <span class="n">hji</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">]</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">hnip</span><span class="o">,</span> <span class="n">exact</span> <span class="n">absurd</span> <span class="n">hip</span> <span class="n">hnip</span> <span class="o">}</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">sum_insert</span> <span class="n">hip</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_insert</span> <span class="n">hip</span><span class="o">],</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">if_pos</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_of_not_mem_vars</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">hip</span><span class="o">,</span> <span class="err">←</span> <span class="n">add_assoc</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">],</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">j</span> <span class="n">hjp</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">if_neg</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">],</span>
        <span class="o">{</span> <span class="n">rintro</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">exact</span> <span class="n">hip</span> <span class="n">hjp</span> <span class="o">}</span> <span class="o">}</span> <span class="o">}</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">end</span> <span class="n">derivation</span>
</pre></div>

<a name="170731921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170731921" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170731921">Kenny Lau (Jul 12 2019 at 15:37)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> here's my progress regarding derivation</p>

<a name="170731936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170731936" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170731936">Kevin Buzzard (Jul 12 2019 at 15:37)</a>:</h4>
<p>I'm looking at it right now</p>


{% endraw %}

{% include archive_update.html %}