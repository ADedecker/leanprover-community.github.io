---
layout: archive
title: Lean Prover Zulip Chat Archive
permalink: archive/116395maths/97398derivation.html
---

<h2>Stream: <a href="https://leanprover-community.github.io/archive/116395maths/index.html">maths</a>
<h3>Topic: <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html">derivation</a></h3>

<hr>

<base href="https://leanprover.zulipchat.com">

{% raw %}
<a name="170730598"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170730598" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170730598">Kenny Lau (Jul 12 2019 at 15:21)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="n">ring_theory</span><span class="bp">.</span><span class="n">algebra</span>

<span class="n">universes</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">u₁</span> <span class="n">v₁</span> <span class="n">w₁</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">R</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">)</span> <span class="o">(</span><span class="n">A</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">)</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">R</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">A</span><span class="o">]</span> <span class="o">[</span><span class="n">algebra</span> <span class="n">R</span> <span class="n">A</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">M</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">)</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">M</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">A</span> <span class="n">M</span><span class="o">]</span>

<span class="c1">-- include R A</span>
<span class="c1">-- def module.comap := M</span>
<span class="c1">-- omit R A</span>

<span class="c1">-- def module.to_comap : M → module.comap R A M := id</span>
<span class="c1">-- def module.of_comap : module.comap R A M → M := id</span>

<span class="c1">-- namespace module.comap</span>

<span class="c1">-- instance : add_comm_group (module.comap R A M) := _inst_4</span>

<span class="c1">-- instance module_right : module A (module.comap R A M) := _inst_5</span>

<span class="c1">-- instance module_left : module R (module.comap R A M) :=</span>
<span class="c1">-- { smul := λ r m, module.to_comap R A M (algebra_map A r • module.of_comap R A M m),</span>
<span class="c1">--   one_smul := λ m, show module.to_comap R A M (algebra_map A (1:R) • module.of_comap R A M m) = m,</span>
<span class="c1">--     by rw [algebra.map_one, one_smul]; refl,</span>
<span class="c1">--   mul_smul := λ r1 r2 m, show module.to_comap R A M (algebra_map A _ • _) = _,</span>
<span class="c1">--     by rw [algebra.map_mul, mul_smul]; refl,</span>
<span class="c1">--   smul_add := λ r m1 m2, by convert smul_add (algebra_map A r) (module.of_comap R A M m1) (module.of_comap R A M m2),</span>
<span class="c1">--   smul_zero := λ r, by convert smul_zero (algebra_map A r),</span>
<span class="c1">--   add_smul := λ r1 r2 m, show module.to_comap R A M (algebra_map A _ • _) = _,</span>
<span class="c1">--     by rw [algebra.map_add, add_smul]; refl,</span>
<span class="c1">--   zero_smul := λ m, show module.to_comap R A M (algebra_map A (0:R) • module.of_comap R A M m) = 0,</span>
<span class="c1">--     by rw [algebra.map_zero, zero_smul]; refl }</span>

<span class="c1">-- end module.comap</span>

<span class="kn">structure</span> <span class="n">derivation</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">to_fun</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">→</span> <span class="n">M</span><span class="o">)</span>
<span class="o">(</span><span class="n">add</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">x</span> <span class="bp">+</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">to_fun</span> <span class="n">x</span> <span class="bp">+</span> <span class="n">to_fun</span> <span class="n">y</span><span class="o">)</span>
<span class="o">(</span><span class="n">mul</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">x</span> <span class="bp">*</span> <span class="n">y</span><span class="o">)</span> <span class="bp">=</span> <span class="n">x</span> <span class="err">•</span> <span class="n">to_fun</span> <span class="n">y</span> <span class="bp">+</span> <span class="n">y</span> <span class="err">•</span> <span class="n">to_fun</span> <span class="n">x</span><span class="o">)</span>
<span class="o">(</span><span class="n">algebra</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">,</span> <span class="n">to_fun</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span> <span class="n">r</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span>

<span class="bp">@</span><span class="o">[</span><span class="n">to_additive</span> <span class="n">add_comm₄</span><span class="o">]</span>
<span class="kn">theorem</span> <span class="n">mul_comm₄</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_semigroup</span> <span class="n">α</span><span class="o">]</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">:</span>
  <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="bp">*</span> <span class="o">(</span><span class="n">c</span> <span class="bp">*</span> <span class="n">d</span><span class="o">)</span> <span class="bp">=</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">*</span> <span class="o">(</span><span class="n">b</span> <span class="bp">*</span> <span class="n">d</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mul_assoc</span><span class="o">,</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="n">mul_left_comm</span> <span class="n">b</span><span class="o">]</span>

<span class="kn">namespace</span> <span class="n">derivation</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_coe_to_fun</span> <span class="o">(</span><span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="bp">⟨λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">A</span> <span class="bp">→</span> <span class="n">M</span><span class="o">,</span> <span class="n">derivation</span><span class="bp">.</span><span class="n">to_fun</span><span class="bp">⟩</span>

<span class="kn">section</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span>
<span class="kn">theorem</span> <span class="n">map_add</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">+</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">D</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">D</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">D</span><span class="bp">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">b</span>
<span class="kn">theorem</span> <span class="n">map_zero</span> <span class="o">:</span> <span class="n">D</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="bp">@@</span><span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_zero</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">D</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span>
<span class="kn">theorem</span> <span class="n">map_neg</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="bp">-</span><span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="bp">-</span><span class="n">D</span> <span class="n">a</span> <span class="o">:=</span> <span class="bp">@@</span><span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_neg</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">D</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span> <span class="bp">_</span>
<span class="kn">theorem</span> <span class="n">map_sub</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">-</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">D</span> <span class="n">a</span> <span class="bp">-</span> <span class="n">D</span> <span class="n">b</span> <span class="o">:=</span> <span class="bp">@@</span><span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_sub</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">⟨</span><span class="n">D</span><span class="bp">.</span><span class="n">add</span><span class="bp">⟩</span> <span class="bp">_</span> <span class="bp">_</span>
<span class="kn">theorem</span> <span class="n">map_mul</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">b</span> <span class="err">•</span> <span class="n">D</span> <span class="n">a</span> <span class="o">:=</span> <span class="n">D</span><span class="bp">.</span><span class="n">mul</span> <span class="n">a</span> <span class="n">b</span>
<span class="kn">theorem</span> <span class="n">map_mul_comm</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">)</span> <span class="bp">=</span> <span class="n">b</span> <span class="err">•</span> <span class="n">D</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">b</span> <span class="o">:=</span> <span class="o">(</span><span class="n">D</span><span class="bp">.</span><span class="n">mul</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span><span class="bp">.</span><span class="n">trans</span> <span class="err">$</span> <span class="n">add_comm</span> <span class="bp">_</span> <span class="bp">_</span>
<span class="kn">theorem</span> <span class="n">map_algebra_map</span> <span class="o">:</span> <span class="n">D</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span> <span class="n">r</span><span class="o">)</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">D</span><span class="bp">.</span><span class="n">algebra</span> <span class="n">r</span>

<span class="bp">@</span><span class="o">[</span><span class="n">extensionality</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">ext</span> <span class="o">:</span> <span class="bp">Π</span> <span class="o">{</span><span class="n">D1</span> <span class="n">D2</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">},</span> <span class="o">(</span><span class="bp">∀</span> <span class="n">a</span><span class="o">,</span> <span class="n">D1</span> <span class="n">a</span> <span class="bp">=</span> <span class="n">D2</span> <span class="n">a</span><span class="o">)</span> <span class="bp">→</span> <span class="n">D1</span> <span class="bp">=</span> <span class="n">D2</span>
<span class="bp">|</span> <span class="bp">⟨</span><span class="n">f</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span> <span class="bp">⟨</span><span class="n">g</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_⟩</span> <span class="n">H</span> <span class="o">:=</span> <span class="n">mk</span><span class="bp">.</span><span class="n">inj_eq</span><span class="bp">.</span><span class="n">mpr</span> <span class="err">$</span> <span class="n">funext</span> <span class="n">H</span>
<span class="kn">end</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="o">(</span><span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">refine</span>
<span class="o">{</span> <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D1</span> <span class="n">D2</span><span class="o">,</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">D1</span> <span class="n">a</span> <span class="bp">+</span> <span class="n">D2</span> <span class="n">a</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D1</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">D2</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D1</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">D2</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D1</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">D2</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">zero</span> <span class="o">:=</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">add_zero</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">smul_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">neg</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="bp">-</span><span class="n">D</span> <span class="n">a</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">neg_add</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">neg_add</span><span class="o">,</span> <span class="n">smul_neg</span><span class="o">,</span> <span class="n">smul_neg</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">]</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="bp">..</span> <span class="o">}</span><span class="bp">;</span>
<span class="o">{</span> <span class="n">intros</span><span class="o">,</span> <span class="n">ext</span><span class="o">,</span> <span class="n">exact</span> <span class="n">add_assoc</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span> <span class="n">exact</span> <span class="n">zero_add</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span>
  <span class="n">exact</span> <span class="n">add_zero</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span> <span class="n">exact</span> <span class="n">add_left_neg</span> <span class="bp">_</span> <span class="bp">&lt;|&gt;</span> <span class="n">exact</span> <span class="n">add_comm</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">module</span> <span class="n">A</span> <span class="o">(</span><span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">D</span><span class="o">,</span> <span class="bp">⟨λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">b</span><span class="o">,</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">],</span>
    <span class="bp">λ</span> <span class="n">s</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">smul_zero</span><span class="o">]</span><span class="bp">⟩</span><span class="o">,</span>
  <span class="n">mul_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">mul_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">one_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">one_smul</span> <span class="n">A</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul_add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">D1</span> <span class="n">D2</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">smul_add</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul_zero</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">smul_zero</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">add_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">add_smul</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">zero_smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">b</span><span class="o">,</span> <span class="n">zero_smul</span> <span class="n">A</span> <span class="bp">_</span> <span class="o">}</span>

<span class="kn">section</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="o">(</span><span class="n">D</span> <span class="n">D1</span> <span class="n">D2</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">add_apply</span> <span class="o">:</span> <span class="o">(</span><span class="n">D1</span> <span class="bp">+</span> <span class="n">D2</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">D1</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">D2</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">zero_apply</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">neg_apply</span> <span class="o">:</span> <span class="o">(</span><span class="bp">-</span><span class="n">D</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="bp">-</span><span class="o">(</span><span class="n">D</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">sub_apply</span> <span class="o">:</span> <span class="o">(</span><span class="n">D1</span> <span class="bp">-</span> <span class="n">D2</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">D1</span> <span class="n">b</span> <span class="bp">-</span> <span class="n">D2</span> <span class="n">b</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="kn">set_option</span> <span class="n">class</span><span class="bp">.</span><span class="n">instance_max_depth</span> <span class="mi">41</span>
<span class="bp">@</span><span class="o">[</span><span class="n">simp</span><span class="o">]</span> <span class="kn">lemma</span> <span class="n">smul_apply</span> <span class="o">:</span> <span class="o">(</span><span class="n">a</span> <span class="err">•</span> <span class="n">D</span><span class="o">)</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">a</span> <span class="err">•</span> <span class="o">(</span><span class="n">D</span> <span class="n">b</span><span class="o">)</span> <span class="o">:=</span> <span class="n">rfl</span>
<span class="kn">end</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span>
<span class="n">def</span> <span class="n">comp</span> <span class="o">{</span><span class="n">N</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u₁</span><span class="o">}</span> <span class="o">[</span><span class="n">add_comm_group</span> <span class="n">N</span><span class="o">]</span> <span class="o">[</span><span class="n">module</span> <span class="n">A</span> <span class="n">N</span><span class="o">]</span>
  <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">M</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">N</span><span class="o">)</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">N</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">f</span> <span class="o">(</span><span class="n">D</span> <span class="n">a</span><span class="o">),</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_add</span><span class="o">],</span>
  <span class="n">mul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">],</span>
  <span class="n">algebra</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">map_zero</span><span class="o">]</span> <span class="o">}</span>

<span class="kn">end</span> <span class="n">derivation</span>

<span class="kn">variables</span> <span class="o">(</span><span class="n">R</span> <span class="n">A</span><span class="o">)</span>

<span class="n">def</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">relators</span> <span class="o">:</span> <span class="n">set</span> <span class="o">(</span><span class="n">free_abelian_group</span> <span class="o">(</span><span class="n">A</span> <span class="bp">×</span> <span class="n">A</span><span class="o">))</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">x</span> <span class="o">:</span> <span class="n">free_abelian_group</span> <span class="o">(</span><span class="n">A</span> <span class="bp">×</span> <span class="n">A</span><span class="o">)</span> <span class="bp">|</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">+</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="bp">+</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="bp">∨</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span> <span class="bp">+</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="bp">+</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">c</span><span class="o">))</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="bp">∨</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span> <span class="bp">*</span> <span class="n">c</span><span class="o">)</span> <span class="bp">-</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="bp">+</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">c</span><span class="o">,</span> <span class="n">b</span><span class="o">))</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="bp">∨</span>
  <span class="o">(</span><span class="bp">∃</span> <span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">,</span> <span class="bp">∃</span> <span class="n">r</span> <span class="o">:</span> <span class="n">R</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">algebra_map</span> <span class="n">A</span> <span class="n">r</span><span class="o">)</span> <span class="bp">=</span> <span class="n">x</span><span class="o">)</span> <span class="o">}</span>

<span class="n">def</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span> <span class="o">:=</span>
<span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">quotient</span> <span class="err">$</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">closure</span> <span class="err">$</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">relators</span> <span class="n">R</span> <span class="n">A</span>

<span class="kn">namespace</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">add_comm_group</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">add_comm_group</span> <span class="bp">_</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">normal_add_subgroup</span> <span class="o">(</span><span class="n">add_group</span><span class="bp">.</span><span class="n">closure</span> <span class="o">(</span><span class="n">relators</span> <span class="n">R</span> <span class="n">A</span><span class="o">))</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">normal</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">n</span> <span class="n">hn</span> <span class="n">g</span><span class="o">,</span> <span class="k">by</span> <span class="n">rwa</span> <span class="n">add_sub_cancel&#39;</span> <span class="o">}</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">has_scalar</span> <span class="n">A</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="bp">⟨λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span>
    <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span> <span class="o">:</span> <span class="n">A</span> <span class="bp">×</span> <span class="n">A</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="err">$</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span> <span class="bp">*</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span><span class="o">,</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span><span class="o">))</span> <span class="bp">_⟩</span><span class="o">,</span>
  <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span> <span class="n">refine</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">in_closure</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">hx</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">y</span> <span class="n">hy</span><span class="o">,</span> <span class="n">rcases</span> <span class="n">hy</span> <span class="k">with</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">|</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">|</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span> <span class="bp">|</span> <span class="bp">⟨</span><span class="n">b</span><span class="o">,</span><span class="n">r</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span>
          <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span>
          <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span>
          <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_assoc</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_assoc</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="bp">_</span><span class="o">),</span>
      <span class="n">change</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">_</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">hx</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span> <span class="n">y</span> <span class="n">hx</span> <span class="n">hy</span> <span class="n">ihx</span> <span class="n">ihy</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihx</span><span class="o">,</span> <span class="n">ihy</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">module</span> <span class="n">A</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="o">{</span> <span class="n">smul</span> <span class="o">:=</span> <span class="o">(</span><span class="err">•</span><span class="o">),</span> <span class="bp">..</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">rw</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">a1</span> <span class="n">a2</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">],</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span>
          <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_assoc</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span>
        <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)],</span> <span class="n">apply_instance</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span> <span class="n">x</span> <span class="n">y</span><span class="o">,</span> <span class="n">exact</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="bp">_</span> <span class="bp">_</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span><span class="o">,</span> <span class="n">exact</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_zero</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span> <span class="n">s</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">],</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">add_mul</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="o">(</span><span class="bp">_</span> <span class="o">:</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">)),</span> <span class="n">rw</span> <span class="n">add_comm</span><span class="o">,</span>
      <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">)</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_add</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">x</span><span class="o">,</span> <span class="n">refine</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">x</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">],</span>
    <span class="n">refine</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="n">rfl</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="bp">⟩</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">zero_mul</span><span class="o">],</span>
      <span class="n">refine</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="o">(</span><span class="bp">_</span> <span class="o">:</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">),</span> <span class="n">rw</span> <span class="n">add_zero</span><span class="o">,</span>
      <span class="n">refine</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">p2</span><span class="o">,</span> <span class="bp">_⟩</span><span class="o">),</span>
      <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">sub_sub</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">,</span> <span class="n">zero_sub</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">ih</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]</span> <span class="o">}</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>

<a name="170730675"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170730675" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170730675">Kenny Lau (Jul 12 2019 at 15:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">def</span> <span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="err">$</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">a</span><span class="o">),</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="err">$</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="err">$</span> <span class="k">show</span> <span class="bp">_</span> <span class="err">∈</span> <span class="bp">_</span><span class="o">,</span>
    <span class="k">by</span> <span class="n">rw</span> <span class="n">add_comm</span><span class="bp">;</span> <span class="n">exact</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="o">(</span><span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="bp">_</span><span class="o">,</span> <span class="n">rfl</span><span class="bp">⟩</span><span class="o">),</span>
  <span class="n">mul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">)]</span><span class="bp">;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">mul_comm</span> <span class="bp">_</span> <span class="o">(</span><span class="mi">1</span><span class="o">:</span><span class="n">A</span><span class="o">)]</span><span class="bp">;</span>
    <span class="n">exact</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="o">(</span><span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="err">$</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inl</span> <span class="bp">⟨</span><span class="mi">1</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">sub_eq_neg_add</span><span class="bp">⟩</span><span class="o">),</span>
  <span class="n">algebra</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">r</span><span class="o">,</span> <span class="n">eq</span><span class="bp">.</span><span class="n">symm</span> <span class="err">$</span> <span class="n">quotient</span><span class="bp">.</span><span class="n">sound&#39;</span> <span class="err">$</span> <span class="n">add_group</span><span class="bp">.</span><span class="n">subset_closure</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="err">$</span> <span class="n">or</span><span class="bp">.</span><span class="n">inr</span> <span class="bp">⟨</span><span class="mi">1</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">neg_zero</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">]</span><span class="bp">⟩</span> <span class="o">}</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span><span class="o">}</span>

<span class="kn">theorem</span> <span class="n">smul_D</span> <span class="o">(</span><span class="n">a</span> <span class="n">b</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span> <span class="n">a</span> <span class="err">•</span> <span class="n">D</span> <span class="n">R</span> <span class="n">A</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">))</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[(</span><span class="err">•</span><span class="o">),</span> <span class="n">D</span><span class="o">]</span><span class="bp">;</span> <span class="n">erw</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>

<span class="bp">@</span><span class="o">[</span><span class="n">elab_as_eliminator</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">induction_on</span> <span class="o">{</span><span class="n">C</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hd</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="o">((</span><span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="err">•</span> <span class="n">D</span> <span class="n">R</span> <span class="n">A</span> <span class="n">b</span><span class="o">))</span> <span class="o">(</span><span class="n">ha</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">C</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">C</span> <span class="o">(</span><span class="n">a</span><span class="bp">+</span><span class="n">b</span><span class="o">))</span> <span class="o">:</span> <span class="n">C</span> <span class="n">p</span> <span class="o">:=</span>
<span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
  <span class="o">(</span><span class="k">by</span> <span class="n">simpa</span> <span class="n">only</span> <span class="o">[</span><span class="n">zero_smul</span><span class="o">]</span> <span class="kn">using</span> <span class="n">hd</span> <span class="mi">0</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="bp">⟩</span><span class="o">,</span> <span class="k">by</span> <span class="k">have</span> <span class="o">:=</span> <span class="n">hd</span> <span class="n">a</span> <span class="n">b</span><span class="bp">;</span> <span class="n">rwa</span> <span class="n">smul_D</span> <span class="n">at</span> <span class="n">this</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="bp">⟩</span> <span class="n">ih</span><span class="o">,</span> <span class="k">by</span> <span class="k">have</span> <span class="o">:=</span> <span class="n">hd</span> <span class="o">(</span><span class="bp">-</span><span class="n">a</span><span class="o">)</span> <span class="n">b</span><span class="bp">;</span> <span class="n">rwa</span> <span class="o">[</span><span class="n">neg_smul</span><span class="o">,</span> <span class="n">smul_D</span><span class="o">]</span> <span class="n">at</span> <span class="n">this</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="n">ha</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span>

<span class="bp">@</span><span class="o">[</span><span class="n">elab_as_eliminator</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">induction_on&#39;</span> <span class="o">{</span><span class="n">C</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span> <span class="kt">Prop</span><span class="o">}</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span>
  <span class="o">(</span><span class="n">hd</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">mk</span> <span class="err">$</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">of</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)))</span> <span class="o">(</span><span class="n">ha</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="n">C</span> <span class="n">a</span> <span class="bp">→</span> <span class="n">C</span> <span class="n">b</span> <span class="bp">→</span> <span class="n">C</span> <span class="o">(</span><span class="n">a</span><span class="bp">+</span><span class="n">b</span><span class="o">))</span> <span class="o">:</span> <span class="n">C</span> <span class="n">p</span> <span class="o">:=</span>
<span class="n">induction_on</span> <span class="n">p</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="n">smul_D</span><span class="bp">;</span> <span class="n">apply</span> <span class="n">hd</span><span class="o">)</span> <span class="n">ha</span>

<span class="kn">end</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span>

<span class="kn">namespace</span> <span class="n">derivation</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">}</span>

<span class="n">def</span> <span class="n">factor</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">M</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="n">p</span><span class="bp">.</span><span class="mi">1</span> <span class="err">•</span> <span class="n">D</span> <span class="n">p</span><span class="bp">.</span><span class="mi">2</span><span class="o">)</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">x</span> <span class="n">hx</span><span class="o">,</span>
    <span class="n">add_group</span><span class="bp">.</span><span class="n">in_closure</span><span class="bp">.</span><span class="n">rec_on</span> <span class="n">hx</span>
      <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">hp</span><span class="o">,</span> <span class="n">or</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">hp</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">add_smul</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">])</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">hp</span><span class="o">,</span> <span class="n">or</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">hp</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">])</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">hp</span><span class="o">,</span> <span class="n">or</span><span class="bp">.</span><span class="n">cases_on</span> <span class="n">hp</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">])</span>
        <span class="o">(</span><span class="k">by</span> <span class="n">rintros</span> <span class="bp">⟨</span><span class="n">a</span><span class="o">,</span><span class="n">r</span><span class="o">,</span><span class="n">rfl</span><span class="bp">⟩;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">sub</span><span class="o">,</span>
            <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">smul_zero</span><span class="o">,</span> <span class="n">sub_self</span><span class="o">]))</span>
      <span class="o">(</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">zero</span> <span class="bp">_</span><span class="o">)</span>
      <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">hp</span> <span class="n">ih</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">neg</span><span class="o">,</span> <span class="n">ih</span><span class="o">,</span> <span class="n">neg_zero</span><span class="o">])</span>
      <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">hp</span> <span class="n">hq</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">]),</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_smul</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">smul_D</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span>
        <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">smul_D</span><span class="o">,</span> <span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">mul_smul</span><span class="o">])</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">q</span> <span class="n">r</span> <span class="n">ihq</span> <span class="n">ihr</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_add</span><span class="o">,</span> <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">ihq</span><span class="o">,</span> <span class="n">ihr</span><span class="o">,</span>
        <span class="n">is_add_group_hom</span><span class="bp">.</span><span class="n">map_add</span> <span class="o">(</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">),</span> <span class="n">smul_add</span><span class="o">]</span><span class="bp">;</span> <span class="n">apply_instance</span><span class="o">)</span> <span class="o">}</span>

<span class="kn">theorem</span> <span class="n">factor_comp</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor</span> <span class="bp">=</span> <span class="n">D</span> <span class="o">:=</span>
<span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">a</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[</span><span class="n">comp</span><span class="o">,</span> <span class="n">factor</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span><span class="o">,</span> <span class="n">coe_fn</span><span class="o">,</span> <span class="n">has_coe_to_fun</span><span class="bp">.</span><span class="n">coe</span><span class="o">]</span><span class="bp">;</span>
<span class="n">erw</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="n">one_smul</span><span class="o">]</span>

<span class="kn">theorem</span> <span class="n">factor_D</span> <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span> <span class="n">a</span><span class="o">)</span> <span class="bp">=</span> <span class="n">D</span> <span class="n">a</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">conv_rhs</span> <span class="o">{</span> <span class="n">rw</span> <span class="err">←</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor_comp</span> <span class="o">}</span><span class="bp">;</span> <span class="n">refl</span>

<span class="kn">theorem</span> <span class="n">comp_factor</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">M</span><span class="o">)</span> <span class="o">:</span> <span class="o">((</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span><span class="o">)</span><span class="bp">.</span><span class="n">comp</span> <span class="n">f</span><span class="o">)</span><span class="bp">.</span><span class="n">factor</span> <span class="bp">=</span> <span class="n">f</span> <span class="o">:=</span>
<span class="n">linear_map</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on&#39;</span> <span class="n">p</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span> <span class="o">[</span><span class="n">comp</span><span class="o">,</span> <span class="n">factor</span><span class="o">,</span> <span class="n">coe_fn</span><span class="o">,</span> <span class="n">has_coe_to_fun</span><span class="bp">.</span><span class="n">coe</span><span class="o">]</span><span class="bp">;</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">quotient_add_group</span><span class="bp">.</span><span class="n">lift_mk&#39;</span><span class="o">,</span> <span class="n">free_abelian_group</span><span class="bp">.</span><span class="n">lift</span><span class="bp">.</span><span class="n">of</span><span class="o">,</span> <span class="err">←</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">smul_D</span><span class="o">,</span> <span class="n">f</span><span class="bp">.</span><span class="n">smul</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span><span class="o">)</span>
  <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">f</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">])</span>

<span class="n">def</span> <span class="n">linear_equiv</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span> <span class="err">≃ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span> <span class="n">R</span> <span class="n">A</span> <span class="bp">→</span><span class="err">ₗ</span><span class="o">[</span><span class="n">A</span><span class="o">]</span> <span class="n">M</span><span class="o">)</span> <span class="o">:=</span>
<span class="o">{</span> <span class="n">to_fun</span> <span class="o">:=</span> <span class="n">factor</span><span class="o">,</span>
  <span class="n">inv_fun</span> <span class="o">:=</span> <span class="n">comp</span> <span class="o">(</span><span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">D</span> <span class="n">R</span> <span class="n">A</span><span class="o">),</span>
  <span class="n">left_inv</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">factor_comp</span><span class="o">,</span>
  <span class="n">right_inv</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">f</span><span class="o">,</span> <span class="n">comp_factor</span> <span class="n">f</span><span class="o">,</span>
  <span class="n">add</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">D1</span> <span class="n">D2</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">a</span> <span class="n">b</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span>
        <span class="n">factor_D</span><span class="o">,</span> <span class="n">factor_D</span><span class="o">,</span> <span class="n">factor_D</span><span class="o">,</span> <span class="n">derivation</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">])</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">]),</span>
  <span class="n">smul</span> <span class="o">:=</span> <span class="bp">λ</span> <span class="n">a</span> <span class="n">D</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">ext</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">p</span><span class="o">,</span> <span class="err">«</span><span class="n">K</span><span class="err">ä</span><span class="n">hler</span><span class="err">»</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">b</span> <span class="n">c</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">smul_apply</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_smul</span><span class="o">,</span>
        <span class="n">factor_D</span><span class="o">,</span> <span class="n">factor_D</span><span class="o">,</span> <span class="n">derivation</span><span class="bp">.</span><span class="n">smul_apply</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">smul_smul</span><span class="o">,</span> <span class="n">mul_comm</span><span class="o">])</span>
    <span class="o">(</span><span class="bp">λ</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">linear_map</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">])</span> <span class="o">}</span>

<span class="kn">end</span> <span class="n">derivation</span>

<span class="bp">@</span><span class="o">[</span><span class="n">monotonicity</span><span class="o">]</span> <span class="kn">theorem</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">to_finset_mono</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span>
  <span class="o">{</span><span class="n">m₁</span> <span class="n">m₂</span> <span class="o">:</span> <span class="n">multiset</span> <span class="n">α</span><span class="o">}</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">m₁</span> <span class="err">⊆</span> <span class="n">m₂</span><span class="o">)</span> <span class="o">:</span> <span class="n">m₁</span><span class="bp">.</span><span class="n">to_finset</span> <span class="err">⊆</span> <span class="n">m₂</span><span class="bp">.</span><span class="n">to_finset</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">]</span><span class="bp">;</span> <span class="n">exact</span> <span class="bp">@</span><span class="n">h</span> <span class="n">i</span>

<span class="kn">namespace</span> <span class="n">finsupp</span>

<span class="n">local</span> <span class="n">attribute</span> <span class="o">[</span><span class="kn">instance</span><span class="o">]</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">to_has_scalar&#39;</span>
<span class="kn">lemma</span> <span class="n">sum_smul_index&#39;</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">{</span><span class="n">γ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">w</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">[</span><span class="n">semiring</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">add_comm_monoid</span> <span class="n">γ</span><span class="o">]</span> <span class="o">{</span><span class="n">g</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span><span class="err">₀</span> <span class="n">β</span><span class="o">}</span> <span class="o">{</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">}</span> <span class="o">{</span><span class="n">h</span> <span class="o">:</span> <span class="n">α</span> <span class="bp">→</span> <span class="n">β</span> <span class="bp">→</span> <span class="n">γ</span><span class="o">}</span>
  <span class="o">(</span><span class="n">h0</span> <span class="o">:</span> <span class="bp">∀</span><span class="n">i</span><span class="o">,</span> <span class="n">h</span> <span class="n">i</span> <span class="mi">0</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="o">(</span><span class="n">b</span> <span class="err">•</span> <span class="n">g</span><span class="o">)</span><span class="bp">.</span><span class="n">sum</span> <span class="n">h</span> <span class="bp">=</span> <span class="n">g</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span><span class="n">i</span> <span class="n">a</span><span class="o">,</span> <span class="n">h</span> <span class="n">i</span> <span class="o">(</span><span class="n">b</span> <span class="bp">*</span> <span class="n">a</span><span class="o">))</span> <span class="o">:=</span>
<span class="n">sum_map_range_index</span> <span class="n">h0</span>

<span class="kn">lemma</span> <span class="n">single_eq_smul_one</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">{</span><span class="n">β</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">β</span><span class="o">]</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">β</span><span class="o">]</span>
  <span class="o">(</span><span class="n">a</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span> <span class="o">:</span> <span class="n">β</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">single</span> <span class="n">a</span> <span class="n">b</span> <span class="bp">=</span> <span class="n">b</span> <span class="err">•</span> <span class="n">single</span> <span class="n">a</span> <span class="mi">1</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">smul_single</span><span class="o">,</span> <span class="n">smul_eq_mul</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">]</span>

<span class="kn">end</span> <span class="n">finsupp</span>

<span class="kn">namespace</span> <span class="n">mv_polynomial</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">σ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">σ</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_semiring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">i</span> <span class="n">j</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span>

<span class="n">def</span> <span class="n">partial_deriv</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span> <span class="o">:=</span>
<span class="c1">-- p.sum $ λ v r, C r * (add_monoid.smul (v i) (X i ^ (v i - 1)) * v.prod (λ j n, if i = j then 1 else (mv_polynomial.X j)^n))</span>
<span class="n">p</span><span class="bp">.</span><span class="n">sum</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">v</span> <span class="n">r</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="o">(</span><span class="n">v</span><span class="bp">.</span><span class="n">sum</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">j</span> <span class="n">n</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">j</span> <span class="o">(</span><span class="k">if</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">j</span> <span class="k">then</span> <span class="n">n</span><span class="bp">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">n</span><span class="o">))</span> <span class="o">(</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul</span> <span class="o">(</span><span class="n">v</span> <span class="n">i</span><span class="o">)</span> <span class="n">r</span><span class="o">)</span>

<span class="c1">-- #exit</span>
<span class="kn">theorem</span> <span class="n">partial_deriv_add</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">+</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">+</span> <span class="n">q</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="o">:=</span>
<span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_add_index</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">v</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span><span class="o">)</span> <span class="err">$</span>
<span class="bp">λ</span> <span class="n">v</span> <span class="n">a1</span> <span class="n">a2</span><span class="o">,</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_add</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_add</span><span class="o">]</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_zero</span> <span class="o">:</span> <span class="o">(</span><span class="mi">0</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_zero_index</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_C</span> <span class="o">:</span> <span class="o">(</span><span class="n">C</span> <span class="n">r</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="o">(</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span> <span class="err">$</span> <span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span><span class="o">)</span><span class="bp">.</span><span class="n">trans</span> <span class="err">$</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">zero_apply</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_X</span> <span class="o">:</span> <span class="o">(</span><span class="n">X</span> <span class="n">i</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">j</span> <span class="bp">=</span> <span class="k">if</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">j</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">X</span><span class="o">,</span> <span class="n">monomial</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">sub_self</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">],</span>
  <span class="o">{</span> <span class="n">split_ifs</span> <span class="k">with</span> <span class="n">hji</span> <span class="n">hij</span> <span class="n">hij</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">one_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">exact</span> <span class="n">absurd</span> <span class="n">hji</span><span class="bp">.</span><span class="n">symm</span> <span class="n">hij</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">exact</span> <span class="n">absurd</span> <span class="n">hij</span><span class="bp">.</span><span class="n">symm</span> <span class="n">hji</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">split_ifs</span> <span class="k">with</span> <span class="n">hji</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">nat</span><span class="bp">.</span><span class="n">zero_sub</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span> <span class="o">}</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_one</span> <span class="o">:</span> <span class="o">(</span><span class="mi">1</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="k">by</span> <span class="n">rw</span> <span class="o">[</span><span class="err">←</span> <span class="n">C_1</span><span class="o">,</span> <span class="n">partial_deriv_C</span><span class="o">]</span>

<span class="kn">instance</span> <span class="o">:</span> <span class="n">semimodule</span> <span class="n">α</span> <span class="o">(</span><span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">:=</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">to_semimodule</span> <span class="bp">_</span> <span class="bp">_</span>

<span class="kn">theorem</span> <span class="n">C_mul&#39;&#39;</span> <span class="o">:</span> <span class="n">C</span> <span class="n">r</span> <span class="bp">*</span> <span class="n">p</span> <span class="bp">=</span> <span class="n">r</span> <span class="err">•</span> <span class="n">p</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">refine</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">p</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">exact</span> <span class="o">(</span><span class="n">mul_zero</span> <span class="bp">_</span><span class="o">)</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">smul_zero</span> <span class="bp">_</span><span class="o">)</span><span class="bp">.</span><span class="n">symm</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span> <span class="n">s</span> <span class="n">f</span> <span class="n">hfv</span> <span class="n">hs</span> <span class="n">ih</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">smul_add</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">C</span><span class="o">,</span> <span class="n">monomial</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">mul_def</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">smul_single</span><span class="o">,</span> <span class="n">smul_eq_mul</span><span class="o">],</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">]</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">zero_mul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">}</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_smul</span> <span class="o">:</span> <span class="o">(</span><span class="n">r</span> <span class="err">•</span> <span class="n">p</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">r</span> <span class="err">•</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_smul_index&#39;</span><span class="o">,</span> <span class="n">partial_deriv</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">mul_sum</span><span class="o">],</span> <span class="n">refine</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_congr</span> <span class="n">rfl</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span> <span class="n">hv</span><span class="o">,</span> <span class="n">dsimp</span> <span class="n">only</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_eq_mul</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_eq_mul</span><span class="o">,</span> <span class="n">mul_left_comm</span><span class="o">,</span> <span class="err">←</span> <span class="n">smul_eq_mul</span><span class="o">,</span> <span class="err">←</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">smul_single</span><span class="o">,</span> <span class="n">C_mul&#39;&#39;</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">}</span>
<span class="kn">end</span>
</pre></div>

<a name="170730690"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170730690" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170730690">Kenny Lau (Jul 12 2019 at 15:22)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kn">theorem</span> <span class="n">partial_deriv_mul</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">+</span> <span class="n">q</span> <span class="bp">*</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">v</span> <span class="n">w</span> <span class="o">:</span> <span class="n">σ</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">,</span> <span class="n">w</span> <span class="n">i</span> <span class="bp">≠</span> <span class="mi">0</span> <span class="bp">→</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="n">v</span> <span class="bp">+</span> <span class="n">w</span><span class="o">)</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">j</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">j</span> <span class="o">(</span><span class="n">ite</span> <span class="o">(</span><span class="n">i</span> <span class="bp">=</span> <span class="n">j</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span><span class="o">)</span> <span class="n">n</span><span class="o">))</span> <span class="bp">=</span>
    <span class="n">v</span> <span class="bp">+</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span> <span class="n">w</span> <span class="o">(</span><span class="bp">λ</span> <span class="o">(</span><span class="n">j</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="o">:</span> <span class="bp">ℕ</span><span class="o">),</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single</span> <span class="n">j</span> <span class="o">(</span><span class="n">ite</span> <span class="o">(</span><span class="n">i</span> <span class="bp">=</span> <span class="n">j</span><span class="o">)</span> <span class="o">(</span><span class="n">n</span> <span class="bp">-</span> <span class="mi">1</span><span class="o">)</span> <span class="n">n</span><span class="o">)),</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">v</span> <span class="n">w</span> <span class="n">hw</span><span class="o">,</span> <span class="n">ext</span> <span class="n">j</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_single</span> <span class="n">j</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_single</span> <span class="n">j</span><span class="o">],</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">],</span> <span class="n">split_ifs</span> <span class="k">with</span> <span class="n">hij</span><span class="o">,</span>
      <span class="o">{</span> <span class="n">subst</span> <span class="n">hij</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">nat</span><span class="bp">.</span><span class="n">add_sub_assoc</span><span class="o">],</span> <span class="n">exact</span> <span class="n">nat</span><span class="bp">.</span><span class="n">one_le_of_lt</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="n">hw</span><span class="o">)</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">refl</span> <span class="o">}</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">k</span> <span class="n">hk</span> <span class="n">hkj</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">hkj</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">hjw</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">],</span> <span class="n">split_ifs</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">not_mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hjw</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">k</span> <span class="n">hk</span> <span class="n">hkj</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_neg</span> <span class="n">hkj</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">intros</span> <span class="n">hjw</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_apply</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">],</span> <span class="n">split_ifs</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">not_mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hjw</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">refine</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">p</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">v</span> <span class="n">r</span> <span class="n">p</span> <span class="n">hpv</span> <span class="n">hr</span> <span class="n">ihp</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
  <span class="o">{</span> <span class="n">erw</span> <span class="n">zero_mul</span><span class="o">,</span> <span class="n">rw</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">erw</span> <span class="n">partial_deriv_zero</span><span class="o">,</span> <span class="n">rw</span> <span class="n">mul_zero</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_mul</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">],</span> <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="bp">_</span> <span class="n">ihp</span><span class="o">)</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_mul</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">refine</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">induction</span> <span class="n">q</span> <span class="bp">_</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">w</span> <span class="n">s</span> <span class="n">q</span> <span class="n">hqw</span> <span class="n">hs</span> <span class="n">ihq</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
  <span class="o">{</span> <span class="n">erw</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">rw</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">erw</span> <span class="n">zero_mul</span><span class="o">,</span> <span class="n">rw</span> <span class="n">partial_deriv_zero</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">mul_add</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">],</span> <span class="n">refine</span> <span class="n">eq</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">congr_arg</span> <span class="bp">_</span> <span class="n">ihq</span><span class="o">)</span> <span class="bp">_</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_mul</span><span class="o">,</span> <span class="n">partial_deriv_add</span><span class="o">,</span> <span class="n">mul_add</span><span class="o">,</span> <span class="n">add_comm₄</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">single_mul_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_eq_smul_one</span> <span class="n">v</span> <span class="n">r</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_eq_smul_one</span> <span class="n">w</span> <span class="n">s</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_eq_smul_one</span> <span class="o">(</span><span class="n">v</span><span class="bp">+</span><span class="n">w</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span><span class="bp">*</span><span class="n">s</span><span class="o">)],</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv_smul</span><span class="o">,</span> <span class="n">partial_deriv_smul</span><span class="o">,</span> <span class="n">partial_deriv_smul</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul&#39;&#39;</span><span class="o">],</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">mul_comm₄</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul</span><span class="o">,</span> <span class="n">mul_comm₄</span><span class="o">,</span> <span class="err">←</span> <span class="n">C_mul</span><span class="o">,</span> <span class="n">mul_comm</span> <span class="n">s</span> <span class="n">r</span><span class="o">,</span> <span class="err">←</span> <span class="n">mul_add</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">partial_deriv</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">sum_single_index</span><span class="o">],</span> <span class="n">swap</span><span class="o">,</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">smul_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">finsupp</span><span class="bp">.</span><span class="n">add_apply</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_mul_single</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_mul_single</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">,</span> <span class="n">one_mul</span><span class="o">],</span>
  <span class="n">by_cases</span> <span class="n">hv</span> <span class="o">:</span> <span class="n">v</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">hv</span><span class="o">,</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">],</span> <span class="n">erw</span> <span class="n">add_zero</span><span class="o">,</span>
    <span class="n">by_cases</span> <span class="n">hw</span> <span class="o">:</span> <span class="n">w</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">hw</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="n">v</span> <span class="n">w</span> <span class="n">hw</span><span class="o">]</span> <span class="o">}</span> <span class="o">},</span>
  <span class="n">by_cases</span> <span class="n">hw</span> <span class="o">:</span> <span class="n">w</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">hw</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">],</span> <span class="n">erw</span> <span class="n">zero_add</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_comm</span> <span class="n">v</span> <span class="n">w</span><span class="o">,</span> <span class="n">this</span> <span class="n">w</span> <span class="n">v</span> <span class="n">hv</span><span class="o">]</span> <span class="o">},</span>
  <span class="n">rw</span> <span class="o">[</span><span class="n">add_monoid</span><span class="bp">.</span><span class="n">add_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_add</span><span class="o">,</span> <span class="n">add_comm</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">rw</span> <span class="n">this</span> <span class="n">v</span> <span class="n">w</span> <span class="n">hw</span> <span class="o">},</span> <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">add_comm</span> <span class="n">v</span> <span class="n">w</span><span class="o">,</span> <span class="n">this</span> <span class="n">w</span> <span class="n">v</span> <span class="n">hv</span><span class="o">]</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">theorem</span> <span class="n">vars_add</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">+</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">vars</span> <span class="err">⊆</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="k">by</span> <span class="n">unfold</span> <span class="n">vars</span><span class="bp">;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_union</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">]</span><span class="bp">;</span> <span class="n">exact</span>
<span class="bp">λ</span> <span class="n">hi</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_add</span><span class="bp">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span>
  <span class="o">(</span><span class="n">le_trans</span> <span class="o">(</span><span class="n">degrees_add</span> <span class="n">p</span> <span class="n">q</span><span class="o">)</span> <span class="err">$</span> <span class="n">lattice</span><span class="bp">.</span><span class="n">sup_le</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">le_add_right</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">le_add_left</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">))</span> <span class="n">hi</span><span class="o">)</span>

<span class="kn">theorem</span> <span class="n">vars_mul</span> <span class="o">:</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">q</span><span class="o">)</span><span class="bp">.</span><span class="n">vars</span> <span class="err">⊆</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="k">by</span> <span class="n">unfold</span> <span class="n">vars</span><span class="bp">;</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">mem_union</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="o">]</span><span class="bp">;</span> <span class="n">exact</span>
<span class="bp">λ</span> <span class="n">hi</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_add</span><span class="bp">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="o">(</span><span class="n">degrees_mul</span> <span class="n">p</span> <span class="n">q</span><span class="o">)</span> <span class="n">hi</span><span class="o">)</span>

<span class="kn">theorem</span> <span class="n">vars_X_subset</span> <span class="o">:</span> <span class="n">vars</span> <span class="o">(</span><span class="n">X</span> <span class="n">i</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="err">⊆</span> <span class="o">{</span><span class="n">i</span><span class="o">}</span> <span class="o">:=</span>
<span class="bp">λ</span> <span class="n">j</span> <span class="n">hj</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="o">(</span><span class="n">degrees_X</span> <span class="n">i</span><span class="o">)</span> <span class="err">$</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hj</span>

<span class="kn">theorem</span> <span class="n">of_not_mem_vars</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">i</span> <span class="err">∉</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">σ</span> <span class="bp">→</span><span class="err">₀</span> <span class="bp">ℕ</span><span class="o">)</span> <span class="o">(</span><span class="n">hv</span> <span class="o">:</span> <span class="n">v</span> <span class="err">∈</span> <span class="n">p</span><span class="bp">.</span><span class="n">support</span><span class="o">)</span> <span class="o">:</span> <span class="n">v</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">finsupp</span><span class="bp">.</span><span class="n">not_mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">hiv</span><span class="o">,</span> <span class="n">h</span> <span class="err">$</span>
<span class="k">have</span> <span class="n">h1</span> <span class="o">:</span> <span class="n">v</span><span class="bp">.</span><span class="n">to_multiset</span> <span class="bp">≤</span> <span class="n">p</span><span class="bp">.</span><span class="n">degrees</span> <span class="o">:=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">le_sup</span> <span class="n">hv</span><span class="o">,</span>
<span class="k">have</span> <span class="n">h2</span> <span class="o">:</span> <span class="bp">_</span> <span class="bp">≤</span> <span class="n">v</span><span class="bp">.</span><span class="n">to_multiset</span> <span class="o">:=</span> <span class="n">finset</span><span class="bp">.</span><span class="n">single_le_sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">zero_le</span> <span class="bp">_</span><span class="o">)</span> <span class="n">hiv</span><span class="o">,</span>
<span class="n">multiset</span><span class="bp">.</span><span class="n">mem_to_finset</span><span class="bp">.</span><span class="mi">2</span> <span class="err">$</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="n">h1</span> <span class="err">$</span> <span class="n">multiset</span><span class="bp">.</span><span class="n">subset_of_le</span> <span class="n">h2</span> <span class="err">$</span>
<span class="k">by</span> <span class="n">rw</span> <span class="err">←</span> <span class="n">nat</span><span class="bp">.</span><span class="n">succ_pred_eq_of_pos</span> <span class="o">(</span><span class="n">nat</span><span class="bp">.</span><span class="n">pos_of_ne_zero</span> <span class="err">$</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">mem_support_iff</span><span class="bp">.</span><span class="mi">1</span> <span class="n">hiv</span><span class="o">)</span><span class="bp">;</span> <span class="n">exact</span>
<span class="n">multiset</span><span class="bp">.</span><span class="n">mem_cons_self</span> <span class="bp">_</span> <span class="bp">_</span>

<span class="kn">theorem</span> <span class="n">partial_deriv_of_not_mem_vars</span> <span class="o">(</span><span class="n">h</span> <span class="o">:</span> <span class="n">i</span> <span class="err">∉</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">:</span> <span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span> <span class="bp">=</span> <span class="mi">0</span> <span class="o">:=</span>
<span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_zero</span> <span class="err">$</span> <span class="bp">λ</span> <span class="n">v</span> <span class="n">hv</span><span class="o">,</span> <span class="k">by</span> <span class="n">dsimp</span> <span class="n">only</span><span class="bp">;</span> <span class="n">rw</span> <span class="o">[</span><span class="n">of_not_mem_vars</span> <span class="n">i</span> <span class="n">p</span> <span class="n">h</span> <span class="n">v</span> <span class="n">hv</span><span class="o">,</span> <span class="n">add_monoid</span><span class="bp">.</span><span class="n">zero_smul</span><span class="o">,</span> <span class="n">finsupp</span><span class="bp">.</span><span class="n">single_zero</span><span class="o">]</span><span class="bp">;</span> <span class="n">refl</span>

<span class="kn">end</span> <span class="n">mv_polynomial</span>

<span class="kn">namespace</span> <span class="n">derivation</span>

<span class="kn">variables</span> <span class="o">{</span><span class="n">σ</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">u</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">σ</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">{</span><span class="n">α</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">comm_ring</span> <span class="n">α</span><span class="o">]</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">α</span><span class="o">]</span>
<span class="kn">variables</span> <span class="o">(</span><span class="n">i</span> <span class="o">:</span> <span class="n">σ</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="n">q</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">σ</span> <span class="n">α</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span> <span class="o">:</span> <span class="n">α</span><span class="o">)</span>

<span class="c">/-</span><span class="cm"> protected def mv_polynomial : derivation α (mv_polynomial σ α) (mv_polynomial σ α) :=</span>
<span class="cm">{ to_fun := mv_polynomial.partial_deriv i,</span>
<span class="cm">  add := mv_polynomial.partial_deriv_add i,</span>
<span class="cm">  mul := mv_polynomial.partial_deriv_mul i,</span>
<span class="cm">  algebra := mv_polynomial.partial_deriv_C i } -/</span>

<span class="kn">theorem</span> <span class="n">mv_polynomial_eval</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">R</span><span class="o">]</span> <span class="o">{</span><span class="n">ι</span> <span class="o">:</span> <span class="kt">Type</span> <span class="n">v</span><span class="o">}</span> <span class="o">[</span><span class="n">decidable_eq</span> <span class="n">ι</span><span class="o">]</span>
  <span class="o">(</span><span class="n">D</span> <span class="o">:</span> <span class="n">derivation</span> <span class="n">R</span> <span class="n">A</span> <span class="n">M</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">ι</span> <span class="n">R</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="n">ι</span> <span class="bp">→</span> <span class="n">A</span><span class="o">)</span> <span class="o">:</span>
  <span class="n">D</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span><span class="o">)</span> <span class="bp">=</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span> <span class="err">•</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">))</span> <span class="o">:=</span>
<span class="k">begin</span>
  <span class="k">have</span> <span class="o">:</span> <span class="bp">∀</span> <span class="n">p</span> <span class="o">:</span> <span class="n">mv_polynomial</span> <span class="n">ι</span> <span class="n">R</span><span class="o">,</span> <span class="bp">∀</span> <span class="n">q</span> <span class="o">:</span> <span class="n">finset</span> <span class="n">ι</span><span class="o">,</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">⊆</span> <span class="n">q</span> <span class="bp">→</span>
    <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span> <span class="err">•</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">))</span> <span class="bp">=</span>
    <span class="n">q</span><span class="bp">.</span><span class="n">sum</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">partial_deriv</span> <span class="n">i</span><span class="o">)</span><span class="bp">.</span><span class="n">eval₂</span> <span class="o">(</span><span class="n">algebra_map</span> <span class="n">A</span><span class="o">)</span> <span class="n">f</span> <span class="err">•</span> <span class="n">D</span> <span class="o">(</span><span class="n">f</span> <span class="n">i</span><span class="o">)),</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">hpq</span><span class="o">,</span> <span class="n">refine</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_subset</span> <span class="n">hpq</span> <span class="o">(</span><span class="bp">λ</span> <span class="n">i</span> <span class="n">hiq</span> <span class="n">hip</span><span class="o">,</span> <span class="bp">_</span><span class="o">),</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_of_not_mem_vars</span> <span class="n">i</span> <span class="n">p</span> <span class="n">hip</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">]</span> <span class="o">},</span>
  <span class="n">refine</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">induction_on</span> <span class="n">p</span> <span class="bp">_</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">,</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">r</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_C</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_algebra_map</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_C</span><span class="o">],</span> <span class="n">refl</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">q</span> <span class="n">ihp</span> <span class="n">ihq</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_add</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_add</span><span class="o">,</span> <span class="n">ihp</span><span class="o">,</span> <span class="n">ihq</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="n">p</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_left</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="n">q</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_right</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="o">(</span><span class="n">p</span><span class="bp">+</span><span class="n">q</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="n">q</span><span class="bp">.</span><span class="n">vars</span><span class="o">)</span> <span class="o">(</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_add</span> <span class="n">p</span> <span class="n">q</span><span class="o">)],</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_add</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_add</span><span class="o">,</span> <span class="n">add_smul</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_add_distrib</span><span class="o">]</span> <span class="o">},</span>
  <span class="o">{</span> <span class="n">intros</span> <span class="n">p</span> <span class="n">i</span> <span class="n">ih</span><span class="o">,</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_mul</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_X</span><span class="o">,</span> <span class="n">D</span><span class="bp">.</span><span class="n">map_mul</span><span class="o">,</span> <span class="n">ih</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">this</span> <span class="o">(</span><span class="n">p</span> <span class="bp">*</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">X</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">p</span><span class="bp">.</span><span class="n">vars</span> <span class="err">∪</span> <span class="o">{</span><span class="n">i</span><span class="o">})</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_mul</span> <span class="n">p</span> <span class="bp">_</span><span class="o">)</span>
        <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">union_subset</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_left</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">)</span>
        <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset</span><span class="bp">.</span><span class="n">trans</span> <span class="o">(</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">vars_X_subset</span> <span class="bp">_</span><span class="o">)</span> <span class="o">(</span><span class="n">finset</span><span class="bp">.</span><span class="n">subset_union_right</span> <span class="bp">_</span> <span class="bp">_</span><span class="o">))))],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">union_comm</span><span class="o">,</span> <span class="err">←</span> <span class="n">finset</span><span class="bp">.</span><span class="n">insert_eq</span><span class="o">],</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_mul</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_add</span><span class="o">,</span> <span class="n">add_smul</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_add_distrib</span><span class="o">],</span>
    <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_mul</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_X</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_X</span><span class="o">],</span>
    <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">smul_sum</span><span class="o">],</span> <span class="n">simp</span> <span class="n">only</span> <span class="o">[</span><span class="n">smul_smul</span><span class="o">],</span>
    <span class="n">by_cases</span> <span class="n">hip</span> <span class="o">:</span> <span class="n">i</span> <span class="err">∈</span> <span class="n">p</span><span class="bp">.</span><span class="n">vars</span><span class="o">,</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="n">finset</span><span class="bp">.</span><span class="n">insert_eq_of_mem</span> <span class="n">hip</span><span class="o">,</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_single</span> <span class="n">i</span><span class="o">,</span> <span class="n">if_pos</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">],</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">j</span> <span class="n">hjp</span> <span class="n">hji</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">if_neg</span> <span class="n">hji</span><span class="bp">.</span><span class="n">symm</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">]</span> <span class="o">},</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">hnip</span><span class="o">,</span> <span class="n">exact</span> <span class="n">absurd</span> <span class="n">hip</span> <span class="n">hnip</span> <span class="o">}</span> <span class="o">},</span>
    <span class="o">{</span> <span class="n">rw</span> <span class="o">[</span><span class="n">finset</span><span class="bp">.</span><span class="n">sum_insert</span> <span class="n">hip</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_insert</span> <span class="n">hip</span><span class="o">],</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">if_pos</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_one</span><span class="o">,</span> <span class="n">mul_one</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">partial_deriv_of_not_mem_vars</span> <span class="bp">_</span> <span class="bp">_</span> <span class="n">hip</span><span class="o">,</span> <span class="err">←</span> <span class="n">add_assoc</span><span class="o">],</span> <span class="n">congr&#39;</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">rw</span> <span class="o">[</span><span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">,</span> <span class="n">finset</span><span class="bp">.</span><span class="n">sum_eq_zero</span><span class="o">,</span> <span class="n">add_zero</span><span class="o">],</span>
      <span class="o">{</span> <span class="n">intros</span> <span class="n">j</span> <span class="n">hjp</span><span class="o">,</span> <span class="n">rw</span> <span class="o">[</span><span class="n">if_neg</span><span class="o">,</span> <span class="n">mv_polynomial</span><span class="bp">.</span><span class="n">eval₂_zero</span><span class="o">,</span> <span class="n">mul_zero</span><span class="o">,</span> <span class="n">zero_smul</span><span class="o">],</span>
        <span class="o">{</span> <span class="n">rintro</span> <span class="n">rfl</span><span class="o">,</span> <span class="n">exact</span> <span class="n">hip</span> <span class="n">hjp</span> <span class="o">}</span> <span class="o">}</span> <span class="o">}</span> <span class="o">}</span>
<span class="kn">end</span>

<span class="kn">end</span> <span class="n">derivation</span>
</pre></div>

<a name="170731921"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170731921" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170731921">Kenny Lau (Jul 12 2019 at 15:37)</a>:</h4>
<p><span class="user-mention" data-user-id="110038">@Kevin Buzzard</span> here's my progress regarding derivation</p>

<a name="170731936"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170731936" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170731936">Kevin Buzzard (Jul 12 2019 at 15:37)</a>:</h4>
<p>I'm looking at it right now</p>

<a name="170734390"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170734390" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170734390">Kevin Buzzard (Jul 12 2019 at 16:08)</a>:</h4>
<p>Should there be a stricklandization? If a module has these properties, then it satisfies the universal property of the Kähler differentials?</p>

<a name="170734499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170734499" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170734499">Kenny Lau (Jul 12 2019 at 16:09)</a>:</h4>
<p>I'm not sure what the properties should be</p>

<a name="170734730"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170734730" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170734730">Kevin Buzzard (Jul 12 2019 at 16:12)</a>:</h4>
<p>More generally, every time a new mathematical structure is made from old structures, there should be an accompanying predicate to say "I am isomorphic to this construction", because this is what mathematicians need in practice.</p>

<a name="170735223"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170735223" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170735223">Kevin Buzzard (Jul 12 2019 at 16:18)</a>:</h4>
<p>Patrick was just talking about the following construction. Say you have an abelian group, and a filter on this group which you should think of as the filter of neighbourhoods of zero for a topology making this group into a topological group. This filter must then satisfy a couple of axioms (zero must be in all the elements, subtraction must be continuous at 0) and then you can <em>define</em> a topology on the abelian group by shifting the filter to every point using the group law and then defining the topology from the neighbourhood filters of every point using some standard trick in mathlib. This construction is all well and good, but the problem is what happens if you have a group which already has a topology and a filter of neighbourhoods of zero? The new topology you can make will probably not be defeq to the one you have. So you need a predicate "I am isomorphic to this thing you just made". </p>
<p>We have a technical problem in the perfectoid project because we defined a super-general valuation taking values in <code>with_zero Gamma</code> for Gamma a linearly ordered comm group. That <code>with_zero Gamma</code> is a construction. Now Rob's norm on the p-adic numbers takes values in the reals, and he proves that the values are always non-negative, so we easily get a norm taking values in the non-negative reals. Guess what. That's not equal to <code>with_zero Gamma</code> . So given that construction of <code>with_zero Gamma</code> we should have defined a predicate on totally ordered comm monoids with zero saying "I am isomorphic to <code>with_zero G</code> for some group G` and we should have developed all of the theory for these monoids instead.</p>
<p>There is a general philosophy here, the extent of which I am only just understanding. But it seems to me that it applies to every time you make a new construction from an old one, e.g. a module of differentials from a morphism of rings, and you will find your object easier to use if you make this predicate now and then don't prove things about the construction but about objects satisfying the predicate.</p>

<a name="170735373"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170735373" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170735373">Mario Carneiro (Jul 12 2019 at 16:21)</a>:</h4>
<p>I also want to point out that this approach alleviates many of the requirements for <code>transfer</code></p>

<a name="170735395"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170735395" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170735395">Kevin Buzzard (Jul 12 2019 at 16:21)</a>:</h4>
<p>Oh! I hadn't really internalised that part of it.</p>

<a name="170736043"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736043" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736043">Andrew Ashworth (Jul 12 2019 at 16:30)</a>:</h4>
<p>Yup. This is the problem that type classes are supposed to solve in the first place... which is why we have theories of <code>distribs</code>.</p>

<a name="170736063"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736063" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736063">Andrew Ashworth (Jul 12 2019 at 16:31)</a>:</h4>
<p>A type class is a universal property and you pick and choose only the ones you need.</p>

<a name="170736296"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736296" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736296">Andrew Ashworth (Jul 12 2019 at 16:35)</a>:</h4>
<p>At least, that's how I think of it. Opinionated programmers love saying things like "composition over inheritance" and such.</p>

<a name="170736337"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736337" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736337">Kevin Buzzard (Jul 12 2019 at 16:35)</a>:</h4>
<p>So if <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> is an <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>-algebra and <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span> is an <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span>-module and <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mo>:</mo><mi>A</mi><mo>→</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">d:A\to M</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span> is an <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>-derivation then we need to write down a list of necessary and sufficient conditions to ensure <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mo>≅</mo><msubsup><mi mathvariant="normal">Ω</mi><mrow><mi>A</mi><mi mathvariant="normal">/</mi><mi>R</mi></mrow><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">M\cong\Omega^1_{A/R}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≅</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.3111079999999997em;vertical-align:-0.49699999999999994em;"></span><span class="mord"><span class="mord">Ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999998em;"><span style="top:-2.378em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">A</span><span class="mord mtight">/</span><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49699999999999994em;"><span></span></span></span></span></span></span></span></span></span>. We should firstly demand that the range of <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span></span></span></span> spans <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>. And then...hmm. I see your point.</p>

<a name="170736486"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736486" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736486">Mario Carneiro (Jul 12 2019 at 16:37)</a>:</h4>
<p>You can also see some similarities in category theory, where products are defined in this universal way but used as a binary operator by abuse of notation</p>

<a name="170736505"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736505" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736505">Kevin Buzzard (Jul 12 2019 at 16:38)</a>:</h4>
<p>The only way I think of how to do this is via some presentation of A as an R-algebra.</p>

<a name="170736759"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736759" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736759">Kevin Buzzard (Jul 12 2019 at 16:41)</a>:</h4>
<p>You write A as a quotient of a polynomial ring over R (e.g. the quotient of the polynomial ring over R generated by the set A) and then make sure that the formal derivative of everything in the kernel is zero.</p>

<a name="170736775"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736775" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736775">Kevin Buzzard (Jul 12 2019 at 16:41)</a>:</h4>
<p>This might be uncheckable in practice I guess.</p>

<a name="170736794"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736794" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736794">Mario Carneiro (Jul 12 2019 at 16:41)</a>:</h4>
<p>why?</p>

<a name="170736991"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736991" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736991">Andrew Ashworth (Jul 12 2019 at 16:44)</a>:</h4>
<p>PS. In general the verb "to stricklandize" means "extract interface" in programming circles, if you want to waste an evening reading about the problem in computer languages...</p>

<a name="170736999"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170736999" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170736999">Kevin Buzzard (Jul 12 2019 at 16:44)</a>:</h4>
<p>Maybe it doesn't matter whether it's useful or not. If someone finds themself in a position where they have a maths proof that some module is isomorphic to the module of differentials then maybe they can tell us a better predicate</p>

<a name="170737055"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170737055" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170737055">Johan Commelin (Jul 12 2019 at 16:45)</a>:</h4>
<p>The problem is that by that time we won't have developed the API in terms of that predicate... and we'll have to port the entire interface.</p>

<a name="170737093"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170737093" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170737093">Johan Commelin (Jul 12 2019 at 16:46)</a>:</h4>
<p>Isn't there also the <code>I^2/I</code> description, where <code>I</code> is the ideal of the diagonal?</p>

<a name="170737147"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170737147" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170737147">Mario Carneiro (Jul 12 2019 at 16:46)</a>:</h4>
<p>The predicates are proofs, so you can exchange one for a provably equivalent one without breaking anything</p>

<a name="170737149"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170737149" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170737149">Johan Commelin (Jul 12 2019 at 16:46)</a>:</h4>
<p>So that already gives two useful def's</p>

<a name="170737181"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170737181" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170737181">Mario Carneiro (Jul 12 2019 at 16:47)</a>:</h4>
<p>As a first cut at this predicate making you can always use <code>X ~= my_construction</code> where <code>~=</code> is isomorphism of the appropriate kind</p>

<a name="170737294"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170737294" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170737294">Mario Carneiro (Jul 12 2019 at 16:48)</a>:</h4>
<p>You can then try replacing this with a more concrete conjunction of properties, and as long as you are able to prove it's equivalent you can install the new definition without breaking anything</p>

<a name="170740047"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170740047" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170740047">Kevin Buzzard (Jul 12 2019 at 17:25)</a>:</h4>
<p>I haven't got the definition right yet. We need to check that everything in the kernel of the derivation is zero for the right reasons</p>

<a name="170766616"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170766616" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170766616">Kevin Buzzard (Jul 13 2019 at 00:57)</a>:</h4>
<p>How about this: If <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> is an <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>-algebra then say that a pair <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi>M</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(M,d)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">d</span><span class="mclose">)</span></span></span></span> consisting of an <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span>-module <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span> and an <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>-linear derivation <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>→</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">A\to M</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span> "satisfies the Strickland predicate for <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi mathvariant="normal">Ω</mi><mrow><mi>R</mi><mi mathvariant="normal">/</mi><mi>A</mi></mrow><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">\Omega^1_{R/A}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.3111079999999997em;vertical-align:-0.49699999999999994em;"></span><span class="mord"><span class="mord">Ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999998em;"><span style="top:-2.378em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span><span class="mord mtight">/</span><span class="mord mathdefault mtight">A</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49699999999999994em;"><span></span></span></span></span></span></span></span></span></span>" if the induced <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span>-module map <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><msub><mo>⊗</mo><mi>R</mi></msub><mi>A</mi><mo>→</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">A\otimes_R A \to M</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin"><span class="mbin">⊗</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span> sending <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>⊗</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a\otimes b</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>⋅</mo><mi>d</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a\cdot d(b)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.44445em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">d</span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span> is surjective, and secondly, every element of the kernel of this map is in the image of a map to <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><msub><mo>⊗</mo><mi>R</mi></msub><mi>A</mi></mrow><annotation encoding="application/x-tex">A\otimes_R A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin"><span class="mbin">⊗</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> from a certain set <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span>. The set <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span> is an ideal in the polynomial ring <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mo stretchy="false">[</mo><mi>A</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">R[A]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mopen">[</span><span class="mord mathdefault">A</span><span class="mclose">]</span></span></span></span> consisting of multivariate polynomials with coefficients in <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span> and variables in <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span>, and the ideal is the kernel of the map from <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mo stretchy="false">[</mo><mi>A</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">R[A]</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mopen">[</span><span class="mord mathdefault">A</span><span class="mclose">]</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> sending each variable to the corresponding element. T</p>

<a name="170767010"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170767010" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170767010">Kevin Buzzard (Jul 13 2019 at 01:06)</a>:</h4>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span></p>

<a name="170767233"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170767233" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170767233">Kevin Buzzard (Jul 13 2019 at 01:13)</a>:</h4>
<p>This is my attempt to translate the standard exact sequence <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>J</mi><mi mathvariant="normal">/</mi><msup><mi>J</mi><mn>2</mn></msup><mo>→</mo><msubsup><mi mathvariant="normal">Ω</mi><mrow><mi>S</mi><mi mathvariant="normal">/</mi><mi>R</mi></mrow><mn>1</mn></msubsup><msub><mo>⊗</mo><mi>S</mi></msub><mi>A</mi><mo>→</mo><msubsup><mi mathvariant="normal">Ω</mi><mrow><mi>A</mi><mi mathvariant="normal">/</mi><mi>R</mi></mrow><mn>1</mn></msubsup><mo>→</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">J/J^2\to\Omega^1_{S/R}\otimes_S A\to \Omega^1_{A/R}\to 0</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="mord">/</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.09618em;">J</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.3111079999999997em;vertical-align:-0.49699999999999994em;"></span><span class="mord"><span class="mord">Ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999998em;"><span style="top:-2.378em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span><span class="mord mtight">/</span><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49699999999999994em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin"><span class="mbin">⊗</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.3111079999999997em;vertical-align:-0.49699999999999994em;"></span><span class="mord"><span class="mord">Ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999998em;"><span style="top:-2.378em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">A</span><span class="mord mtight">/</span><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49699999999999994em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> into  a predicate, where <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> is the polynomial ring over <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span> with variables in <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> (or more generally a polynomial ring over <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span> with coefficients corresponding to any subset of <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> generating it as an <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>-algebra, so <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> is a flat <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>-module and the canonical map <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mo>→</mo><mi>A</mi></mrow><annotation encoding="application/x-tex">S\to A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> is surjective). Then I think <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi mathvariant="normal">Ω</mi><mrow><mi>S</mi><mi mathvariant="normal">/</mi><mi>R</mi></mrow><mn>1</mn></msubsup></mrow><annotation encoding="application/x-tex">\Omega^1_{S/R}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1.3111079999999997em;vertical-align:-0.49699999999999994em;"></span><span class="mord"><span class="mord">Ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999998em;"><span style="top:-2.378em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span><span class="mord mtight">/</span><span class="mord mathdefault mtight" style="margin-right:0.00773em;">R</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49699999999999994em;"><span></span></span></span></span></span></span></span></span></span> must just be the direct sum over <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mo>∈</mo><mi>A</mi></mrow><annotation encoding="application/x-tex">a\in A</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span></span></span></span> of <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mi>D</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>a</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SD(x_a)</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>. And <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.09618em;">J</span></span></span></span> is the kernel of <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>S</mi><mo>→</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">S\to R</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span></span></span></span>.</p>

<a name="170774672"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170774672" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170774672">Johan Commelin (Jul 13 2019 at 05:16)</a>:</h4>
<p>I guess such a predicate would work (in the sense that it is correct), but it looks quite complicated. We'll probably have to see in practice whether it's actually usable.</p>

<a name="170774676"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170774676" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170774676">Johan Commelin (Jul 13 2019 at 05:16)</a>:</h4>
<p><span class="user-mention" data-user-id="110064">@Kenny Lau</span> Is your next step the sheaf <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi mathvariant="normal">Ω</mi><mn>1</mn></msup></mrow><annotation encoding="application/x-tex">\Omega^1</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">Ω</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span>?</p>

<a name="170783439"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170783439" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170783439">Kevin Buzzard (Jul 13 2019 at 09:54)</a>:</h4>
<p>The point is that if you don't do it like this then you'll have trouble further down the line when you have a localisation of the one forms instead of the one forms of the localisation and you can't rewrite</p>

<a name="170783489"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170783489" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170783489">Kevin Buzzard (Jul 13 2019 at 09:56)</a>:</h4>
<p>You won't be able to glue one forms and thus define the one forms on a general scheme unless you do this now</p>

<a name="170783499"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170783499" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170783499">Kevin Buzzard (Jul 13 2019 at 09:57)</a>:</h4>
<p>Or am I wrong?</p>

<a name="170783548"></a>
<h4><a href="https://leanprover.zulipchat.com/#narrow/stream/116395-maths/topic/derivation/near/170783548" class="zl"><img src="https://leanprover-community.github.io/assets/img/zulip2.png" alt="view this post on Zulip"></a> <a href="https://leanprover-community.github.io/archive/116395maths/97398derivation.html#170783548">Johan Commelin (Jul 13 2019 at 09:58)</a>:</h4>
<p>Right... I completely agree that such a predicate is what we need. I would hope that we somehow get better in managing them. Maybe those predicates should be turned into structures <code>is_Kaehler_differentials : Prop</code> or something like that...</p>


{% endraw %}

{% include archive_update.html %}